<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‹±æ–‡ã€Œçš„ã€æ–‡æ³•æŒ‘æˆ°</title>
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ --- */
        :root {
            --base-bg: #F1F3F3;       
            --primary-color: #0a9396;   
            --primary-dark: #005f73;    
            --secondary-color: #40916c; 
            --secondary-dark: #2d6a4f;  
            --light-bg-1: #e6eaea;      
            --light-bg-2: #e6f1f0;      
            --text-color: #212529;      
            --border-color: #ced4da;     
            --danger-color: #dc3545;     
            --success-color: #2d6a4f;
            --btn-correct: #2a9d8f;
            --btn-wrong: #e76f51;
            --ai-color: #9b59b6;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--base-bg); 
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #game-container {
            width: 100%;
            max-width: 900px;
            background-color: #ffffff;
            height: 100%; 
            border-radius: 0; 
            box-shadow: none;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        @media (min-width: 600px) {
            body {
                align-items: center;
                padding: 20px;
            }
            #game-container {
                height: auto;
                max-height: 95vh;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                border: 2px solid var(--border-color);
            }
        }

        h1 {
            text-align: center;
            color: var(--primary-dark); 
            margin-top: 5px;
            margin-bottom: 10px;
            font-size: 20px;
            font-weight: 800;
            flex-shrink: 0;
        }

        /* ç‹€æ…‹åˆ— */
        #game-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #555;
            font-size: 14px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        /* è¨ˆæ™‚å™¨æ¨£å¼ */
        .timer-container {
            flex-grow: 1;
            margin: 0 15px;
            position: relative;
            height: 24px;
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #ccc;
        }

        #timer-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--primary-color);
            width: 100%;
            transition: width 0.1s linear, background-color 0.3s;
        }

        .timer-text {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-family: monospace;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            z-index: 2;
        }

        /* é¡Œç›®é¡¯ç¤ºå€ */
        #question-area {
            background-color: var(--light-bg-1);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            text-align: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        #chinese-display {
            font-size: 22px;
            color: #333;
            font-weight: bold;
            line-height: 1.3;
        }

        /* ç¬¬ä¸€éƒ¨åˆ†ï¼š12å®®æ ¼åˆ†é¡æŒ‰éˆ• */
        #category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            #category-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .category-btn {
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            background-color: white;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .category-btn:hover {
            border-color: var(--primary-color);
            background-color: var(--light-bg-2);
        }

        .category-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }

        /* ç¬¬äºŒéƒ¨åˆ†ï¼šæ–‡å­—è¼¸å…¥å€ */
        #typing-area {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .typing-instruction {
            text-align: center;
            color: var(--success-color);
            font-weight: bold;
            font-size: 16px;
        }

        #english-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            box-sizing: border-box;
            background-color: #fff;
            color: #333;
        }

        #english-input:focus { border-color: var(--primary-color); outline: none; }
        #english-input:disabled { background-color: #e9ecef; color: #888; cursor: not-allowed; }

        #submit-sentence-btn {
            background-color: var(--primary-color);
            min-width: 150px;
            align-self: center;
            font-size: 18px;
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }
        
        #submit-sentence-btn:hover:not(:disabled) { background-color: var(--primary-dark); }
        
        #submit-sentence-btn:disabled {
            background-color: var(--ai-color);
            cursor: wait;
            animation: pulse-ai 1.5s infinite;
        }

        @keyframes pulse-ai {
            0% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(155, 89, 182, 0); }
            100% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); }
        }

        /* åé¥‹èˆ‡æ§åˆ¶ */
        #feedback-area {
            text-align: center;
            min-height: 50px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .feedback-text { font-size: 16px; font-weight: bold; line-height: 1.5; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box;}
        .text-correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .text-wrong { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; text-align: left; }
        .explanation-hint { font-size: 14px; color: #555; margin-top: 8px; font-weight: normal;}
        
        /* AI å¾½ç«  */
        .ai-badge {
            display: inline-block;
            background-color: var(--ai-color);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 5px;
            vertical-align: middle;
        }

        #controls {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .control-btn {
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            min-width: 110px;
        }

        #next-btn { background-color: var(--primary-dark); display: none; margin-left: auto;}
        #back-btn { background-color: white; color: var(--primary-color); border: 2px solid var(--primary-color); transition: all 0.2s;}
        #back-btn:hover { background-color: var(--primary-color); color: white; }

        /* éŠæˆ²çµæŸç•«é¢ */
        #end-screen { display: none; text-align: center; width: 100%; }
        .end-game-container { text-align: center; padding: 10px; }
        .final-score { font-size: 40px; font-weight: 900; color: var(--secondary-dark); margin: 20px 0; border: 4px solid var(--secondary-color); padding: 20px; display: inline-block; border-radius: 8px; background-color: var(--light-bg-2); }
        .error-analysis { margin-top: 30px; text-align: left; border-top: 2px solid var(--border-color); padding-top: 20px; max-height: 50vh; overflow-y: auto; }
        .error-item { margin-bottom: 15px; padding: 12px; border-left: 4px solid var(--danger-color); background-color: #fff5f5; border-radius: 4px; font-size: 15px;}
        .result-controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .result-btn { padding: 12px 20px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; min-width: 120px; border: 2px solid transparent; }
        .btn-menu { background-color: white; color: var(--primary-color); border-color: var(--primary-color); }
        .btn-menu:hover { background-color: var(--primary-color); color: white; }
        .btn-retry-wrong { background-color: #e9c46a; color: #333; border-color: #d4a373; }
        .btn-retry-wrong:hover { background-color: #e76f51; color: white; border-color: #e76f51; }
        .btn-restart { background-color: var(--secondary-dark); color: white; border-color: var(--secondary-dark); }
        .btn-restart:hover { background-color: var(--secondary-color); }
/* --- æ–°å¢ï¼šå½ˆçª—èˆ‡ä¸»é¸å–®æ¨£å¼ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 1; transition: opacity 0.3s;
        }
        .modal-overlay.hidden { display: none; opacity: 0; pointer-events: none;}
        .modal-content {
            background: white; width: 90%; max-width: 500px;
            max-height: 85vh; border-radius: 20px; padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow-y: auto; position: relative; text-align: center;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .modal-title { font-size: 1.3rem; color: #333; font-weight: 800; margin: 0;}
        .close-btn { font-size: 2rem; cursor: pointer; color: #999; line-height: 1; margin-top: -5px;}
        .option-label {
            display: flex; align-items: center; gap: 8px; font-size: 14px;
            padding: 10px; background: #f8f9fa; border-radius: 8px; cursor: pointer;
            border: 1px solid #ddd; transition: all 0.2s;
        }
        .option-label:hover { background: #e9ecef; border-color: #bbb; }
        .option-checkbox { width: 16px; height: 16px; cursor: pointer; }
        @media (max-width: 600px) {
            #optionsContainer { grid-template-columns: 1fr !important; } /* æ‰‹æ©Ÿç‰ˆè®Šæˆå–®è¡Œ */
        }
    </style>
</head>
<body>

<div id="game-container">
        
        <div id="startOverlay" style="text-align: center; padding: 20px 10px;">
            <h2 style="color: var(--primary-dark); margin-bottom: 20px; font-size: 26px;">æ­¡è¿ä¾†åˆ°<br>è‹±æ–‡ã€Œçš„ã€æ–‡æ³•æŒ‘æˆ°</h2>
            
            <div style="background: var(--light-bg-1); padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--primary-dark); text-align: center; font-size: 18px;">âš™ï¸ é¸æ“‡ä½ è¦æŒ‘æˆ°çš„ã€Œçš„ã€</div>
                
                <div style="display:flex; gap:10px; margin-bottom:15px; justify-content:center;">
                    <button onclick="selectAllOptions(true)" style="padding: 6px 15px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor:pointer;">å…¨é¸</button>
                    <button onclick="selectAllOptions(false)" style="padding: 6px 15px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor:pointer;">å…¨ä¸é¸</button>
                </div>
                
                <div id="optionsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 40vh; overflow-y: auto;">
                    </div>
            </div>

            <button onclick="startGameSession()" style="background: var(--primary-color); color: white; padding: 15px 40px; font-size: 1.2rem; border-radius: 50px; border:none; cursor:pointer; box-shadow: 0 5px 15px rgba(10, 147, 150, 0.4); font-weight:bold; transition: all 0.2s;">
                â–¶ é–‹å§‹æŒ‘æˆ° (Start)
            </button>
        </div>
        <div id="game-area" style="display: none;">
            <h1>è‹±æ–‡ã€Œçš„ã€æ–‡æ³•æŒ‘æˆ°</h1>

            <div id="game-status-bar">
                <span>Q: <span id="q-current">1</span>/<span id="q-total">10</span></span>
                <div class="timer-container">
                    <div id="timer-bar"></div>
                    <div id="timer-text" class="timer-text">30.0</div>
                </div>
                <span>Score: <span id="score">0</span></span>
            </div>

            <div id="question-area">
                <div id="chinese-display">Loading...</div>
            </div>

            <div id="category-grid"></div>

            <div id="typing-area">
                <div class="typing-instruction">âœ… åˆ†é¡æ­£ç¢ºï¼è«‹è¼¸å…¥å°æ‡‰çš„è‹±æ–‡å¥å­ï¼š</div>
                <input type="text" id="english-input" placeholder="è«‹è¼¸å…¥è‹±æ–‡" autocomplete="off">
                <button id="submit-sentence-btn">æäº¤å¥å­</button>
            </div>

            <div id="feedback-area"></div>

            <div id="controls">
                <button class="control-btn" id="back-btn" onclick="goBackToMenu()">è¿”å›é¸å–®</button>
                <button class="control-btn" id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â”</button>
            </div>
        </div>

        <div id="end-screen"></div>
    </div>
</div> <script src="questions.js"></script>
    <script>
        // ------------------------------------------------------------------
        // â˜… æ ¸å¿ƒ AI API è¨­ç½® (OpenRouter - Gemini 2.5 Flash)
        // ------------------------------------------------------------------
        const keyPart1 = "sk-or-v1-";
        const keyPart2 = "99843d0bae6f77f25b0bf50875a3cc23d9556e7e77d73b2a8828e9b690319381"; 
        const OPENROUTER_API_KEY = keyPart1 + keyPart2;

async function checkAnswerWithAI(studentAnswer, questionChinese, ruleDesc, standardAnswer) {
            const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­ä¸”å¯¬å®¹çš„è‹±æ–‡è€å¸«ï¼Œæ­£åœ¨æ‰¹æ”¹å­¸ç”Ÿçš„ç¿»è­¯é¡Œã€‚
ä¸­æ–‡é¡Œç›®ï¼šã€Œ${questionChinese}ã€
ä¸»è¦è€ƒé©—çš„æ–‡æ³•è¦å‰‡ï¼šã€Œ${ruleDesc}ã€
å…¶ä¸­ä¸€å€‹æ¨™æº–ç­”æ¡ˆæ˜¯ï¼šã€Œ${standardAnswer}ã€

å­¸ç”Ÿæäº¤çš„ç­”æ¡ˆï¼šã€Œ${studentAnswer}ã€

è«‹åˆ¤æ–·å­¸ç”Ÿçš„ç­”æ¡ˆæ˜¯å¦å¯ä»¥æ¥å—ã€‚
åˆ¤æ–·æ¨™æº–ï¼š
1. å…è¨±åˆç†çš„åŒç¾©è© (ä¾‹å¦‚ guest/customer/client, picture/photo, colour/color ç­‰)ã€‚
2. å…è¨±ç¾å¼/è‹±å¼æ‹¼å¯«å·®ç•°ã€‚
3. å…è¨±ä¸å½±éŸ¿ç†è§£çš„æ¥µå¾®å°æ‹¼å­—éŒ¯èª¤ã€‚
4. å¥æ„å¿…é ˆèˆ‡ä¸­æ–‡é¡Œç›®ä¸€è‡´ (æ³¨æ„æƒ…æ…‹å‹•è©çš„èªæ°£ï¼Œä¾‹å¦‚å¯èƒ½ might/may vs æ‡‰è©² should)ã€‚
5. å¯¬å®¹å°å¾…çœç•¥å¥æ³•ï¼šå¦‚æœé¡Œç›®è¦å‰‡æ˜¯æ•™å°ã€Œçœç•¥å¯«æ³•ã€(ä¾‹å¦‚ç›´æ¥åŠ  p.p.ã€ç›´æ¥åŠ å½¢å®¹è©ã€ä»‹è©)ï¼Œä½†å­¸ç”Ÿå¯«äº†å®Œæ•´çš„é—œä¿‚ä»£åè©å­å¥ (ä¾‹å¦‚åŠ ä¸Šäº† who is, which was ç­‰å®Œæ•´çµæ§‹)ï¼Œè«‹å‹™å¿…åˆ¤å®šç‚ºæ­£ç¢º (isCorrect: true)ï¼
6. åªæœ‰åœ¨æ–‡æ³•çµæ§‹å¾¹åº•éŒ¯èª¤æ™‚ (ä¾‹å¦‚è©²ç”¨ of å»ç”¨éŒ¯äº† 'sï¼Œæˆ–æ˜¯å‹•è©å½¢æ…‹å®Œå…¨ç”¨éŒ¯)ï¼Œæ‰åˆ¤å®šç‚ºéŒ¯èª¤ (isCorrect: false)ã€‚

è«‹ä»¥ JSON æ ¼å¼å›è¦†ï¼Œå¿…é ˆåŒ…å«ä»¥ä¸‹å…©å€‹æ¬„ä½ï¼š
"isCorrect": true æˆ– false
"explanation": å¦‚æœéŒ¯äº†ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡ç°¡çŸ­è§£é‡‹éŒ¯åœ¨å“ªè£¡ã€‚å¦‚æœç­”å°äº†ï¼Œä½†å­¸ç”Ÿå¯«äº†å®Œæ•´å­å¥è€Œæ²’æœ‰ä½¿ç”¨ç°¡åŒ–å¯«æ³•ï¼Œè«‹çµ¦äºˆé¼“å‹µï¼Œä¸¦æº«é¦¨è£œå……ã€Œé€™å¥å®Œå…¨æ­£ç¢ºï¼ä¸éå…¶å¯¦ä¹Ÿå¯ä»¥ç°¡åŒ–æˆ...ã€ã€‚åªè¼¸å‡º JSONï¼Œä¸è¦å…¶ä»–å»¢è©±ã€‚`;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href, 
                        "X-Title": "English Grammar Game"
                    },
                    body: JSON.stringify({
                        "model": "google/gemini-2.5-flash", 
                        "messages": [ {"role": "user", "content": prompt} ]
                    })
                });

                if (!response.ok) throw new Error("API error");
                const data = await response.json();
                let reply = data.choices[0].message.content.trim();
                
                // æ¸…ç† AI å¯èƒ½åŒ…å«çš„ Markdown æ¨™ç±¤ (ä¾‹å¦‚ ```json ... ```)
                if (reply.startsWith("```json")) {
                    reply = reply.replace(/^```json/, '').replace(/```$/, '').trim();
                } else if (reply.startsWith("```")) {
                    reply = reply.replace(/^```/, '').replace(/```$/, '').trim();
                }

                const result = JSON.parse(reply);
                return {
                    isCorrect: result.isCorrect === true || result.isCorrect === "true",
                    explanation: result.explanation || ""
                };
            } catch (error) {
                console.error("AI Check failed:", error);
                return { isCorrect: false, explanation: "AI ç³»çµ±ç¹å¿™ï¼Œè«‹åƒè€ƒæ¨™æº–ç­”æ¡ˆã€‚" };
            }
        }


        // ------------------------------------------------------------------
        // 1. åˆ†é¡å®šç¾©èˆ‡è§£é‡‹å°ç…§è¡¨ 
        // ------------------------------------------------------------------
        const categories = [
            { id: 1, name: "ç°¡å–®å½¢å®¹è© / æ•¸å­—+é‡è©" },
            { id: 2, name: "æœ‰ç”Ÿå‘½çš„ (äºº/å‹•ç‰©/åœ°æ–¹ 's)" },
            { id: 3, name: "æœ‰...çš„ (with)" },
            { id: 4, name: "æ²’æœ‰...çš„ (without)" },
            { id: 5, name: "é—œæ–¼...çš„ (about)" },
            { id: 6, name: "ä¸»å‹•å‹•è© / Modal Verb" },
            { id: 7, name: "è¢«å‹•å‹•è© (p.p.)" },
            { id: 8, name: "è¤‡åˆå½¢å®¹è© (afraid of...ç­‰)" },
            { id: 9, name: "å¥å­ + çš„" },
            { id: 10, name: "æ­»ç‰©çš„æ­»ç‰© (the...of...)" },
            { id: 11, name: "åœ°æ–¹ + çš„" },
            { id: 12, name: "æ™‚é–“ + çš„" }
        ];

let selectedCategories = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]; // é è¨­å…¨é¸ 12 æ¬¾

        function renderOptions() {
            const container = document.getElementById('optionsContainer');
            if(!container) return; // é¿å…æ‰¾ä¸åˆ°å…ƒç´ çš„å ±éŒ¯
            container.innerHTML = '';
            categories.forEach(cat => {
                const isChecked = selectedCategories.includes(cat.id) ? 'checked' : '';
                container.innerHTML += `
                    <label class="option-label">
                        <input type="checkbox" class="option-checkbox" value="${cat.id}" ${isChecked}>
                        ${cat.name}
                    </label>
                `;
            });
        }

        function selectAllOptions(selectAll) {
            const checkboxes = document.querySelectorAll('.option-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll);
        }

        function startGameSession() {
            // åœ¨æŒ‰é–‹å§‹éŠæˆ²æ™‚ï¼Œå³æ™‚è®€å–ç©å®¶å‹¾é¸äº†å“ªäº›
            const checkboxes = document.querySelectorAll('.option-checkbox');
            selectedCategories = [];
            checkboxes.forEach(cb => {
                if (cb.checked) selectedCategories.push(parseInt(cb.value));
            });

            if (selectedCategories.length === 0) {
                alert("è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®ã€Œçš„ã€ï¼");
                return;
            }

            document.getElementById('startOverlay').style.display = 'none';
            document.getElementById('game-area').style.display = 'block';
            initGame(false);
        }

        // ç•¶ç¶²é è¼‰å…¥æ™‚ï¼Œç«‹åˆ»åœ¨ç•«é¢ä¸Šç•«å‡ºé¸é …
        window.addEventListener('DOMContentLoaded', () => {
            renderOptions();
        });
        const ruleToCategory = {
            3: 1, 1: 2, 2: 2, 7: 3, 8: 4, 13: 5, 5: 6, 6: 6, 14: 7, 10: 8, 9: 9, 4: 10, 12: 11, 11: 12
        };

        const ruleExplanations = {
            1: "ã€Œçš„ã€å‰é¢æ˜¯äººç¨±æ“æœ‰çš„ç‰©å“ï¼Œä½¿ç”¨ 's å½¢å¼ã€‚",
            2: "ã€Œçš„ã€å‰é¢æ˜¯å‹•ç‰©æˆ–åœ°æ–¹æ“æœ‰çš„äº‹ç‰©ï¼Œä½¿ç”¨ 's å½¢å¼ã€‚",
            3: "é€™å±¬æ–¼ã€Œæ•¸å­—+é‡è©ã€ï¼Œæ•¸å­—å’Œé‡è©ä¹‹é–“éœ€åŠ é€£å­—è™Ÿ (-)ï¼Œä¸”é‡è©ä¸åŠ  sã€‚",
            4: "é€™å±¬æ–¼ã€Œæ­»ç‰©çš„æ­»ç‰©ã€ï¼Œå…©å€‹ç„¡ç”Ÿå‘½çš„åè©éœ€å‰å¾Œèª¿è½‰ä¸¦ç”¨ of é€£æ¥ (the...of...)ã€‚",
            5: "å¾Œç½®ä¿®é£¾ï¼šåŒ…å«ä¸»å‹•å‹•è©ï¼Œä½¿ç”¨ who/which/that + å‹•è©ã€‚",
            6: "å¾Œç½®ä¿®é£¾ï¼šåŒ…å«æƒ…æ…‹å‹•è© (can/will/should ç­‰)ï¼Œä½¿ç”¨ who/which/that + modal + å‹•è©ã€‚",
            7: "è¡¨ç¤ºã€Œæœ‰...çš„ã€ï¼Œæ“æœ‰æŸç‰¹å¾µæˆ–ç‰©å“ï¼Œä½¿ç”¨ä»‹ç³»è© withã€‚",
            8: "è¡¨ç¤ºã€Œæ²’æœ‰...çš„ã€ï¼Œä¸å…·æœ‰æŸç‰¹å¾µæˆ–ç‰©å“ï¼Œä½¿ç”¨ä»‹ç³»è© withoutã€‚",
            9: "ç›´æ¥å°‡ã€Œä¸»èª+å‹•è©ã€çš„å®Œæ•´å¥å­æ”¾åœ¨åè©å¾Œæ–¹ä¿®é£¾ã€‚",
            10: "é€™å±¬æ–¼ã€Œè¤‡åˆå½¢å®¹è©ã€ï¼Œä½¿ç”¨å½¢å®¹è©æ­é…ä»‹ç³»è© (å¦‚ fond of, full of ç­‰) æ”¾åœ¨åè©å¾Œæ–¹ã€‚",
            11: "å°‡æ™‚é–“è©å¾Œç½®åœ¨åè©å¾Œæ–¹ä¿®é£¾ (å¦‚ in the past, tomorrow)ã€‚",
            12: "å°‡åœ°æ–¹å‰¯è©æˆ–ä»‹ç³»è©ç‰‡èªå¾Œç½®åœ¨åè©å¾Œæ–¹ä¿®é£¾ (å¦‚ there, on the table)ã€‚",
            13: "è¡¨ç¤ºå…§å®¹é—œæ–¼æŸäº‹ç‰©ï¼Œä½¿ç”¨ aboutã€‚",
            14: "è¡¨ç¤ºè¢«å‹•å‹•ä½œ (å¦‚è¢«ç¨±ç‚ºã€è¢«è£½é€ )ï¼Œç›´æ¥å°‡éå»åˆ†è© (p.p.) æ”¾åœ¨åè©å¾Œæ–¹ã€‚"
        };
    

        // ------------------------------------------------------------------
        // 3. éŠæˆ²ç‹€æ…‹èˆ‡ DOM
        // ------------------------------------------------------------------
        let currentQIndex = 0;
        let score = 0;
        let currentQ = null;
        let shuffledQuestions = [];
        let gameHistory = []; 
        let currentPhase = 1; // 1 = é¸æ“‡åˆ†é¡, 2 = å¯«å¥å­
        
        // Timer
        let timeLeft = 30;
        let timerInterval = null;
        let defaultPhase1Time = 30;
        let defaultPhase2Time = 40;
        
        const dom = {
            gameArea: document.getElementById('game-area'),
            endScreen: document.getElementById('end-screen'),
            qCurrent: document.getElementById('q-current'),
            qTotal: document.getElementById('q-total'),
            timerBar: document.getElementById('timer-bar'),
            timerText: document.getElementById('timer-text'),
            score: document.getElementById('score'),
            chineseDisplay: document.getElementById('chinese-display'),
            categoryGrid: document.getElementById('category-grid'),
            typingArea: document.getElementById('typing-area'),
            englishInput: document.getElementById('english-input'),
            submitSentenceBtn: document.getElementById('submit-sentence-btn'),
            feedbackArea: document.getElementById('feedback-area'),
            nextBtn: document.getElementById('next-btn'),
            backBtn: document.getElementById('back-btn')
        };

        // éŸ³æ•ˆç³»çµ±
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }
        function playBeep(freq = 800, dur = 0.1) { playTone(freq, 'sine', dur); }

        const sfx = {
            click: () => playTone(600, 'triangle', 0.05),
            correct: () => { playTone(660, 'square', 0.1); setTimeout(() => playTone(880, 'square', 0.2), 100); },
            wrong: () => playTone(200, 'sawtooth', 0.3),
            win: () => { playTone(440, 'sine', 0.1); setTimeout(() => playTone(554, 'sine', 0.1), 100); setTimeout(() => playTone(659, 'sine', 0.2), 200); },
            countdown: () => playBeep(880, 0.1),
            timeup: () => playTone(150, 'sawtooth', 0.5)
        };

        // ------------------------------------------------------------------
        // 4. éŠæˆ²é‚è¼¯
        // ------------------------------------------------------------------
        
function initGame(isRetry = false) {
            currentQIndex = 0;
            score = 0;
            gameHistory = [];
            
            dom.endScreen.style.display = 'none';
            dom.gameArea.style.display = 'block';

            if (!isRetry) {
                // æ‰¾å‡ºæ‰€æœ‰è¢«å‹¾é¸çš„ Category å°æ‡‰çš„ Rule ID
                let allowedRules = Object.keys(ruleToCategory)
                                         .filter(rule => selectedCategories.includes(ruleToCategory[rule]))
                                         .map(Number);
                
                // éæ¿¾é¡Œåº« (åªä¿ç•™è¢«é¸ä¸­çš„è¦å‰‡é¡Œç›®)
                let filteredQuestions = questionBank.filter(q => allowedRules.includes(q.rule));
                
                // å¦‚æœé¡Œåº«ä¸å¤  10 é¡Œï¼Œå°±å…¨æ‹¿ï¼›å¦å‰‡éš¨æ©ŸæŠ½ 10 é¡Œ
                const maxQ = Math.min(10, filteredQuestions.length);
                shuffledQuestions = filteredQuestions.sort(() => Math.random() - 0.5).slice(0, maxQ);
            } 

            if (shuffledQuestions.length === 0) {
                alert("é€™å¹¾é¡å‰›å¥½æ²’æœ‰å°æ‡‰çš„é¡Œç›®ï¼Œè«‹é‡æ–°é¸æ“‡ï¼");
                goBackToMenu();
                return;
            }

            dom.qTotal.innerText = shuffledQuestions.length;
            renderCategories();
            loadQuestion();
        }

        function renderCategories() {
            dom.categoryGrid.innerHTML = '';
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerText = cat.name;
                btn.onclick = () => handleCategoryClick(cat.id, cat.name);
                dom.categoryGrid.appendChild(btn);
            });
        }

        function loadQuestion() {
            if (currentQIndex >= shuffledQuestions.length) {
                endGame();
                return;
            }

            currentPhase = 1;
            currentQ = shuffledQuestions[currentQIndex];
            
            dom.qCurrent.innerText = currentQIndex + 1;
            dom.score.innerText = score;
            dom.chineseDisplay.innerText = currentQ.chinese;
            
            // é‡ç½® UI ç‹€æ…‹
            dom.categoryGrid.style.display = 'grid';
            Array.from(dom.categoryGrid.children).forEach(btn => btn.disabled = false);
            dom.typingArea.style.display = 'none';
            dom.englishInput.value = '';
            dom.englishInput.disabled = false;
            
            dom.submitSentenceBtn.style.display = 'block';
            dom.submitSentenceBtn.disabled = false;
            dom.submitSentenceBtn.innerText = "æäº¤å¥å­";
            
            dom.feedbackArea.innerHTML = '';
            dom.nextBtn.style.display = 'none';
            dom.backBtn.style.display = 'inline-block';

            startTimer(defaultPhase1Time);
        }

        function startTimer(seconds) {
            clearInterval(timerInterval);
            timeLeft = seconds; 
            updateTimerUI();
            
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                
                if (timeLeft <= 3.0 && timeLeft > 0) {
                    if (Math.abs(timeLeft % 1) < 0.1) sfx.countdown();
                }

                if (timeLeft <= 0) {
                    timeLeft = 0;
                    handleTimeout();
                }
                updateTimerUI();
            }, 100);
        }

        function stopTimer() { clearInterval(timerInterval); }

        function updateTimerUI() {
            dom.timerText.innerText = Math.abs(timeLeft).toFixed(1);
            let totalTime = currentPhase === 1 ? defaultPhase1Time : defaultPhase2Time;
            let pct = (timeLeft / totalTime) * 100;
            dom.timerBar.style.width = `${pct}%`;
            
            if (timeLeft <= 5) dom.timerBar.style.backgroundColor = 'var(--danger-color)';
            else dom.timerBar.style.backgroundColor = 'var(--primary-color)';
        }

        function handleTimeout() {
            stopTimer();
            sfx.timeup();
            
            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let correctAnsStr = currentQ.correct_tokens[0].join(' ');
            
            if (currentPhase === 1) {
                Array.from(dom.categoryGrid.children).forEach(btn => btn.disabled = true);
                showFeedback(false, `â° æ™‚é–“åˆ°ï¼<br>æ­£ç¢ºåˆ†é¡: <strong>${correctCatName}</strong><br>æ­£ç¢ºå¥å­: <strong>${correctAnsStr}</strong>`);
                recordHistory(false, "Timeout", false, "Timeout", false);
                showNextBtn();
            } else {
                dom.submitSentenceBtn.style.display = 'none';
                dom.englishInput.disabled = true;
                showFeedback(false, `â° æ™‚é–“åˆ°ï¼<br>æ­£ç¢ºå¥å­: <strong>${correctAnsStr}</strong>`);
                recordHistory(true, correctCatName, false, "Timeout", false);
                showNextBtn();
            }
        }

        // --- éšæ®µä¸€ï¼šåˆ¤æ–·åˆ†é¡ ---
        function handleCategoryClick(selectedId, selectedName) {
            sfx.click();
            stopTimer();
            Array.from(dom.categoryGrid.children).forEach(btn => btn.disabled = true);

            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let correctAnsStr = currentQ.correct_tokens[0].join(' ');
            let explanation = ruleExplanations[currentQ.rule];

            if (selectedId === correctCatId) {
                // ç­”å°äº†
                score += 5;
                dom.score.innerText = score;
                sfx.correct();
                
                dom.categoryGrid.style.display = 'none';
                dom.typingArea.style.display = 'flex';
                dom.englishInput.focus();
                dom.backBtn.style.display = 'none';
                
                currentPhase = 2;
                startTimer(defaultPhase2Time); 
            } else {
                // ç­”éŒ¯äº†
                sfx.wrong();
                let msg = `âŒ é¸æ“‡éŒ¯èª¤ï¼<br>
                           æ­£ç¢ºåˆ†é¡æ˜¯ï¼š<strong>${correctCatName}</strong><br>
                           <div class="explanation-hint">ğŸ’¡ è§£é‡‹ï¼š${explanation}</div><br>
                           æ­£ç¢ºå¥å­æ‡‰ç‚ºï¼š<strong>${correctAnsStr}</strong>`;
                showFeedback(false, msg);
                recordHistory(false, selectedName, false, "(æœªé€²å…¥)", false);
                showNextBtn();
            }
        }

        function formatTextForComparison(text) {
            return text.toLowerCase().trim().replace(/\s+/g, ' ').replace(/[.,!?;]*$/, '');
        }

        // --- éšæ®µäºŒï¼šæª¢æŸ¥è¼¸å…¥çš„å¥å­ (æ•´åˆ AI) ---
       async function checkSentence() {
            if (dom.submitSentenceBtn.disabled) return;
            
            sfx.click();
            stopTimer();

            const userTyping = dom.englishInput.value;
            const formattedUserInput = formatTextForComparison(userTyping);
            
            const correctAnswers = currentQ.correct_tokens.map(arr => arr.join(' '));
            const formattedCorrectAnswers = correctAnswers.map(formatTextForComparison);
            
            let isMatch = formattedCorrectAnswers.includes(formattedUserInput);
            let usedAI = false;
            let aiExplanation = ""; // å„²å­˜ AI è§£é‡‹
            
            dom.submitSentenceBtn.disabled = true;
            dom.englishInput.disabled = true;

            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let ruleDesc = ruleExplanations[currentQ.rule];

            // äº¤çµ¦ AI åˆ¤æ–·
            if (!isMatch && formattedUserInput !== "") {
                usedAI = true;
                dom.submitSentenceBtn.innerText = "ğŸ¤– AI åˆ¤æ–·ä¸­...";
                const aiResult = await checkAnswerWithAI(userTyping, currentQ.chinese, ruleDesc, correctAnswers[0]);
                isMatch = aiResult.isCorrect;
                aiExplanation = aiResult.explanation;
            }
            
            dom.submitSentenceBtn.style.display = 'none';

            if (isMatch) {
                score += 5; 
                dom.score.innerText = score;
                
                let msg = usedAI ? "ğŸ‰ å®Œç¾ï¼AI èªå¯äº†ä½ çš„åŒç¾©è©/å¯«æ³•ï¼" : "ğŸ‰ å®Œç¾ï¼åˆ†é¡èˆ‡å¥å­å®Œå…¨æ­£ç¢ºï¼";
                let badge = usedAI ? `<span class="ai-badge">AI åˆ¤å®š</span>` : "";
                
                showFeedback(true, msg + badge);
                sfx.correct();
                recordHistory(true, correctCatName, true, userTyping, usedAI, aiExplanation);
            } else {
                let badge = usedAI ? `<span class="ai-badge">AI åˆ¤å®š</span>` : "";
                let explanationHtml = aiExplanation ? `<br><div style="color:#d35400; font-size:15px; margin-top:8px; text-align:left; background:#fff3cd; padding:8px; border-radius:6px; border:1px solid #ffeeba;">ğŸ¤– <strong>AI é»è©•ï¼š</strong>${aiExplanation}</div>` : "";
                
                showFeedback(false, `âŒ å¥å­æœ‰èª¤ï¼${badge}<br>æ¨™æº–å¯«æ³•: <strong>${correctAnswers[0]}</strong>${explanationHtml}`);
                sfx.wrong();
                recordHistory(true, correctCatName, false, userTyping, usedAI, aiExplanation);
            }
            
            showNextBtn();
        }

        // ç´€éŒ„éŒ¯é¡Œèˆ‡æ­·å²
      function recordHistory(isCatCorrect, userCatName, isSentenceCorrect, userSentence, usedAI, aiExplanation = "") {
            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let correctSentence = currentQ.correct_tokens[0].join(' ');
            let isCompletelyCorrect = isCatCorrect && isSentenceCorrect;

            gameHistory.push({
                originalObj: currentQ, 
                questionText: currentQ.chinese,
                isCorrect: isCompletelyCorrect,
                isCatCorrect: isCatCorrect,
                correctCatName: correctCatName,
                userCatName: userCatName,
                isSentenceCorrect: isSentenceCorrect,
                correctSentence: correctSentence,
                userSentence: userSentence,
                usedAI: usedAI,
                aiExplanation: aiExplanation,
                explanation: ruleExplanations[currentQ.rule]
            });
        }
        function showFeedback(isSuccess, msg) {
            let colorClass = isSuccess ? 'text-correct' : 'text-wrong';
            dom.feedbackArea.innerHTML = `<div class="feedback-text ${colorClass}">${msg}</div>`;
        }

        function showNextBtn() {
            dom.nextBtn.style.display = 'block';
            dom.backBtn.style.display = 'none';
        }

        function nextQuestion() {
            sfx.click();
            currentQIndex++;
            loadQuestion();
        }

        function retryWrongQuestions() {
            const wrongQuestions = gameHistory.filter(h => !h.isCorrect).map(h => h.originalObj);
            if (wrongQuestions.length === 0) {
                alert("æ²’æœ‰éŒ¯é¡Œå¯ä»¥é‡åšï¼");
                return;
            }
            shuffledQuestions = wrongQuestions;
            initGame(true);
        }

        function endGame() {
            stopTimer();
            dom.gameArea.style.display = 'none';
            dom.endScreen.style.display = 'block';
            sfx.win();

            const totalQ = shuffledQuestions.length;
            const percentage = Math.round((score / (totalQ * 10)) * 100); 

            const wrongAnswers = gameHistory.filter(h => !h.isCorrect);
            let analysisHTML = '';
            
            if (wrongAnswers.length > 0) {
                analysisHTML = `
                    <div class="error-analysis">
                        <h3 style="color:var(--danger-color)">éŒ¯èª¤è¤‡ç¿’ (${wrongAnswers.length} é¡Œ):</h3>
                        ${wrongAnswers.map(item => `
                            <div class="error-item">
                                <div style="margin-bottom:8px; font-weight:bold; color:#333;">é¡Œç›®: ${item.questionText}</div>
                                ${!item.isCatCorrect 
                                    ? `<div style="color:var(--danger-color)">âŒ <strong>åˆ†é¡éŒ¯èª¤:</strong> ä½ é¸äº† ${item.userCatName} (æ­£ç¢ºç‚º ${item.correctCatName})</div>`
                                    : `<div style="color:var(--success-color)">âœ… <strong>åˆ†é¡æ­£ç¢º:</strong> ${item.correctCatName}</div>`
                                }
                                ${!item.isSentenceCorrect && item.isCatCorrect
                                    ? `<div style="color:var(--danger-color)">âŒ <strong>å¥å­éŒ¯èª¤:</strong> ${item.userSentence} ${item.usedAI ? '<span class="ai-badge">AI åˆ¤å®š</span>' : ''}</div><div style="color:var(--primary-dark)"><strong>æ¨™æº–ç­”æ¡ˆ:</strong> ${item.correctSentence}</div>` + (item.aiExplanation ? `<div style="color:#d35400; margin-top:6px; font-size: 0.9em; background:#fff3cd; padding:6px; border-radius:4px;">ğŸ¤– <strong>AI é»è©•:</strong> ${item.aiExplanation}</div>` : "")
                                    : (!item.isCatCorrect ? `<div style="color:var(--primary-dark)"><strong>æ­£ç¢ºå¥å­:</strong> ${item.correctSentence}</div>` : "")
                                }
                                <div style="font-size:0.9em; color:#666; margin-top:5px; padding-top:5px; border-top:1px dashed #ccc;">ğŸ’¡ <strong>ç›¸é—œè¦å‰‡ï¼š</strong>${item.explanation}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                analysisHTML = `<h3 style="color:var(--secondary-dark); margin-top:30px;">å®Œç¾ï¼å…¨å°ï¼ğŸ‰</h3>`;
            }

            const retryBtnStyle = wrongAnswers.length > 0 ? "display:inline-block;" : "display:none;";

            dom.endScreen.innerHTML = `
                <div class="end-game-container">
                    <h1>Challenge Complete!</h1>
                    <div class="final-score">ç¸½å¾—åˆ†: ${score} / ${totalQ * 10} (${percentage}%)</div>
                    ${analysisHTML}
                    <div class="result-controls">
                        <button class="result-btn btn-menu" onclick="goBackToMenu()">è¿”å›é¸å–®</button>
                        <button class="result-btn btn-retry-wrong" style="${retryBtnStyle}" onclick="retryWrongQuestions()">é‡åšéŒ¯é¡Œ</button>
                        <button class="result-btn btn-restart" onclick="initGame()">å†ä¾†ä¸€æ¬¡</button>
                    </div>
                </div>
            `;
        }

        dom.submitSentenceBtn.addEventListener('click', checkSentence);
        dom.englishInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && currentPhase === 2 && !dom.englishInput.disabled && !dom.submitSentenceBtn.disabled) {
                if (dom.englishInput.value.trim() === '') {
                    alert("è«‹è¼¸å…¥è‹±æ–‡å¥å­ï¼");
                    return;
                }
                checkSentence();
            }
        });
        
function goBackToMenu() {
            // ç¾åœ¨æ”¹ç‚ºé€€å›ä¸»é¸å–®ï¼Œè€Œä¸æ˜¯é›¢é–‹é é¢
            stopTimer();
            dom.gameArea.style.display = 'none';
            dom.endScreen.style.display = 'none';
            document.getElementById('startOverlay').style.display = 'block';
            renderOptions(); // è¿”å›æ™‚é‡æ–°é¡¯ç¤ºä¸€ä¸‹é¸é …
        }

    </script>
</body>
</html>





