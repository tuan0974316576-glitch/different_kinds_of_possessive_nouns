<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‹±æ–‡ã€Œçš„ã€æ–‡æ³•æŒ‘æˆ°</title>
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ --- */
        :root {
            --base-bg: #F1F3F3;       
            --primary-color: #0a9396;   
            --primary-dark: #005f73;    
            --secondary-color: #40916c; 
            --secondary-dark: #2d6a4f;  
            --light-bg-1: #e6eaea;      
            --light-bg-2: #e6f1f0;      
            --text-color: #212529;      
            --border-color: #ced4da;     
            --danger-color: #dc3545;     
            --success-color: #2d6a4f;
            --btn-correct: #2a9d8f;
            --btn-wrong: #e76f51;
            --ai-color: #9b59b6;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--base-bg); 
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #game-container {
            width: 100%;
            max-width: 900px;
            background-color: #ffffff;
            height: 100%; 
            border-radius: 0; 
            box-shadow: none;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        @media (min-width: 600px) {
            body {
                align-items: center;
                padding: 20px;
            }
            #game-container {
                height: auto;
                max-height: 95vh;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                border: 2px solid var(--border-color);
            }
        }

        h1 {
            text-align: center;
            color: var(--primary-dark); 
            margin-top: 5px;
            margin-bottom: 10px;
            font-size: 20px;
            font-weight: 800;
            flex-shrink: 0;
        }

        /* ç‹€æ…‹åˆ— */
        #game-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #555;
            font-size: 14px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        /* è¨ˆæ™‚å™¨æ¨£å¼ */
        .timer-container {
            flex-grow: 1;
            margin: 0 15px;
            position: relative;
            height: 24px;
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #ccc;
        }

        #timer-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--primary-color);
            width: 100%;
            transition: width 0.1s linear, background-color 0.3s;
        }

        .timer-text {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-family: monospace;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            z-index: 2;
        }

        /* é¡Œç›®é¡¯ç¤ºå€ */
        #question-area {
            background-color: var(--light-bg-1);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            text-align: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        #chinese-display {
            font-size: 22px;
            color: #333;
            font-weight: bold;
            line-height: 1.3;
        }

        /* ç¬¬ä¸€éƒ¨åˆ†ï¼š12å®®æ ¼åˆ†é¡æŒ‰éˆ• */
        #category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            #category-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .category-btn {
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            background-color: white;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .category-btn:hover {
            border-color: var(--primary-color);
            background-color: var(--light-bg-2);
        }

        .category-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }

        /* ç¬¬äºŒéƒ¨åˆ†ï¼šæ–‡å­—è¼¸å…¥å€ */
        #typing-area {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .typing-instruction {
            text-align: center;
            color: var(--success-color);
            font-weight: bold;
            font-size: 16px;
        }

        #english-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            box-sizing: border-box;
            background-color: #fff;
            color: #333;
        }

        #english-input:focus { border-color: var(--primary-color); outline: none; }
        #english-input:disabled { background-color: #e9ecef; color: #888; cursor: not-allowed; }

        #submit-sentence-btn {
            background-color: var(--primary-color);
            min-width: 150px;
            align-self: center;
            font-size: 18px;
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }
        
        #submit-sentence-btn:hover:not(:disabled) { background-color: var(--primary-dark); }
        
        #submit-sentence-btn:disabled {
            background-color: var(--ai-color);
            cursor: wait;
            animation: pulse-ai 1.5s infinite;
        }

        @keyframes pulse-ai {
            0% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(155, 89, 182, 0); }
            100% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); }
        }

        /* åé¥‹èˆ‡æ§åˆ¶ */
        #feedback-area {
            text-align: center;
            min-height: 50px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .feedback-text { font-size: 16px; font-weight: bold; line-height: 1.5; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box;}
        .text-correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .text-wrong { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; text-align: left; }
        .explanation-hint { font-size: 14px; color: #555; margin-top: 8px; font-weight: normal;}
        
        /* AI å¾½ç«  */
        .ai-badge {
            display: inline-block;
            background-color: var(--ai-color);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 5px;
            vertical-align: middle;
        }

        #controls {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .control-btn {
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            min-width: 110px;
        }

        #next-btn { background-color: var(--primary-dark); display: none; margin-left: auto;}
        #back-btn { background-color: white; color: var(--primary-color); border: 2px solid var(--primary-color); transition: all 0.2s;}
        #back-btn:hover { background-color: var(--primary-color); color: white; }

        /* éŠæˆ²çµæŸç•«é¢ */
        #end-screen { display: none; text-align: center; width: 100%; }
        .end-game-container { text-align: center; padding: 10px; }
        .final-score { font-size: 40px; font-weight: 900; color: var(--secondary-dark); margin: 20px 0; border: 4px solid var(--secondary-color); padding: 20px; display: inline-block; border-radius: 8px; background-color: var(--light-bg-2); }
        .error-analysis { margin-top: 30px; text-align: left; border-top: 2px solid var(--border-color); padding-top: 20px; max-height: 50vh; overflow-y: auto; }
        .error-item { margin-bottom: 15px; padding: 12px; border-left: 4px solid var(--danger-color); background-color: #fff5f5; border-radius: 4px; font-size: 15px;}
        .result-controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .result-btn { padding: 12px 20px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; min-width: 120px; border: 2px solid transparent; }
        .btn-menu { background-color: white; color: var(--primary-color); border-color: var(--primary-color); }
        .btn-menu:hover { background-color: var(--primary-color); color: white; }
        .btn-retry-wrong { background-color: #e9c46a; color: #333; border-color: #d4a373; }
        .btn-retry-wrong:hover { background-color: #e76f51; color: white; border-color: #e76f51; }
        .btn-restart { background-color: var(--secondary-dark); color: white; border-color: var(--secondary-dark); }
        .btn-restart:hover { background-color: var(--secondary-color); }

    </style>
</head>
<body>

    <div id="game-container">
        <div id="game-area">
            <h1>è‹±æ–‡ã€Œçš„ã€æ–‡æ³•æŒ‘æˆ°</h1>

            <div id="game-status-bar">
                <span>Q: <span id="q-current">1</span>/<span id="q-total">10</span></span>
                <div class="timer-container">
                    <div id="timer-bar"></div>
                    <div id="timer-text" class="timer-text">30.0</div>
                </div>
                <span>Score: <span id="score">0</span></span>
            </div>

            <div id="question-area">
                <div id="chinese-display">Loading...</div>
            </div>

            <div id="category-grid"></div>

            <div id="typing-area">
                <div class="typing-instruction">âœ… åˆ†é¡æ­£ç¢ºï¼è«‹è¼¸å…¥å°æ‡‰çš„è‹±æ–‡å¥å­ï¼š</div>
                <input type="text" id="english-input" placeholder="è«‹è¼¸å…¥è‹±æ–‡" autocomplete="off">
                <button id="submit-sentence-btn">æäº¤å¥å­</button>
            </div>

            <div id="feedback-area"></div>

            <div id="controls">
                <button class="control-btn" id="back-btn" onclick="goBackToMenu()">è¿”å›é¸å–®</button>
                <button class="control-btn" id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â”</button>
            </div>
        </div>

        <div id="end-screen"></div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // â˜… æ ¸å¿ƒ AI API è¨­ç½® (OpenRouter - Gemini 2.5 Flash)
        // ------------------------------------------------------------------
        const keyPart1 = "sk-or-v1-";
        const keyPart2 = "99843d0bae6f77f25b0bf50875a3cc23d9556e7e77d73b2a8828e9b690319381"; 
        const OPENROUTER_API_KEY = keyPart1 + keyPart2;

        async function checkAnswerWithAI(studentAnswer, questionChinese, ruleDesc, standardAnswer) {
            const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­ä¸”å¯¬å®¹çš„è‹±æ–‡è€å¸«ï¼Œæ­£åœ¨æ‰¹æ”¹å­¸ç”Ÿçš„ç¿»è­¯é¡Œã€‚
ä¸­æ–‡é¡Œç›®ï¼šã€Œ${questionChinese}ã€
å¿…é ˆä½¿ç”¨çš„æ–‡æ³•è¦å‰‡ï¼šã€Œ${ruleDesc}ã€
å…¶ä¸­ä¸€å€‹æ¨™æº–ç­”æ¡ˆæ˜¯ï¼šã€Œ${standardAnswer}ã€

å­¸ç”Ÿæäº¤çš„ç­”æ¡ˆï¼šã€Œ${studentAnswer}ã€

è«‹åˆ¤æ–·å­¸ç”Ÿçš„ç­”æ¡ˆæ˜¯å¦å¯ä»¥æ¥å—ã€‚
åˆ¤æ–·æ¨™æº–ï¼š
1. å…è¨±åˆç†çš„åŒç¾©è© (ä¾‹å¦‚ table/desk, picture/photo, colour/color, bag/sack ç­‰)ã€‚
2. å…è¨±ç¾å¼/è‹±å¼æ‹¼å¯«å·®ç•° (ä¾‹å¦‚ centre/center)ã€‚
3. å…è¨±ä¸å½±éŸ¿ç†è§£çš„æ¥µå¾®å°æ‹¼å­—éŒ¯èª¤ã€‚
4. å¥æ„å¿…é ˆèˆ‡ä¸­æ–‡é¡Œç›®ä¸€è‡´ã€‚
5. æœ€é‡è¦çš„ä¸€é»ï¼šå¿…é ˆç¬¦åˆè¦å®šçš„æ–‡æ³•è¦å‰‡ï¼å¦‚æœæ–‡æ³•çµæ§‹éŒ¯äº†ï¼ˆä¾‹å¦‚è©²ç”¨ of ä½†ç”¨äº† 'sï¼Œæˆ–è€…ä¸æ‡‰è©²åŠ  s çš„é‡è©åŠ äº† sï¼‰ï¼Œå³ä½¿æ„æ€å°ä¹Ÿæ˜¯éŒ¯çš„ã€‚

è«‹åƒ…å›è¦† "YES" æˆ– "NO"ï¼Œä¸éœ€è¦ä»»ä½•è§£é‡‹ã€‚`;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href, 
                        "X-Title": "English Grammar Game"
                    },
                    body: JSON.stringify({
                        "model": "google/gemini-2.5-flash", 
                        "messages": [ {"role": "user", "content": prompt} ]
                    })
                });

                if (!response.ok) throw new Error("API error");
                const data = await response.json();
                const reply = data.choices[0].message.content.trim().toUpperCase();
                return reply.includes("YES");
            } catch (error) {
                console.error("AI Check failed:", error);
                return false; // å¦‚æœ API æ–·ç·šï¼Œå®‰å…¨èµ·è¦‹ç•¶ä½œéŒ¯èª¤
            }
        }


        // ------------------------------------------------------------------
        // 1. åˆ†é¡å®šç¾©èˆ‡è§£é‡‹å°ç…§è¡¨ 
        // ------------------------------------------------------------------
        const categories = [
            { id: 1, name: "ç°¡å–®å½¢å®¹è© / æ•¸å­—+é‡è©" },
            { id: 2, name: "æœ‰ç”Ÿå‘½çš„ (äºº/å‹•ç‰©/åœ°æ–¹ 's)" },
            { id: 3, name: "æœ‰...çš„ (with)" },
            { id: 4, name: "æ²’æœ‰...çš„ (without)" },
            { id: 5, name: "é—œæ–¼...çš„ (about)" },
            { id: 6, name: "ä¸»å‹•å‹•è© / Modal Verb" },
            { id: 7, name: "è¢«å‹•å‹•è© (p.p.)" },
            { id: 8, name: "è¤‡åˆå½¢å®¹è© (afraid of...ç­‰)" },
            { id: 9, name: "å¥å­ + çš„" },
            { id: 10, name: "æ­»ç‰©çš„æ­»ç‰© (the...of...)" },
            { id: 11, name: "åœ°æ–¹ + çš„" },
            { id: 12, name: "æ™‚é–“ + çš„" }
        ];

        const ruleToCategory = {
            3: 1, 1: 2, 2: 2, 7: 3, 8: 4, 13: 5, 5: 6, 6: 6, 14: 7, 10: 8, 9: 9, 4: 10, 12: 11, 11: 12
        };

        const ruleExplanations = {
            1: "ã€Œçš„ã€å‰é¢æ˜¯äººç¨±æ“æœ‰çš„ç‰©å“ï¼Œä½¿ç”¨ 's å½¢å¼ã€‚",
            2: "ã€Œçš„ã€å‰é¢æ˜¯å‹•ç‰©æˆ–åœ°æ–¹æ“æœ‰çš„äº‹ç‰©ï¼Œä½¿ç”¨ 's å½¢å¼ã€‚",
            3: "é€™å±¬æ–¼ã€Œæ•¸å­—+é‡è©ã€ï¼Œæ•¸å­—å’Œé‡è©ä¹‹é–“éœ€åŠ é€£å­—è™Ÿ (-)ï¼Œä¸”é‡è©ä¸åŠ  sã€‚",
            4: "é€™å±¬æ–¼ã€Œæ­»ç‰©çš„æ­»ç‰©ã€ï¼Œå…©å€‹ç„¡ç”Ÿå‘½çš„åè©éœ€å‰å¾Œèª¿è½‰ä¸¦ç”¨ of é€£æ¥ (the...of...)ã€‚",
            5: "å¾Œç½®ä¿®é£¾ï¼šåŒ…å«ä¸»å‹•å‹•è©ï¼Œä½¿ç”¨ who/which/that + å‹•è©ã€‚",
            6: "å¾Œç½®ä¿®é£¾ï¼šåŒ…å«æƒ…æ…‹å‹•è© (can/will/should ç­‰)ï¼Œä½¿ç”¨ who/which/that + modal + å‹•è©ã€‚",
            7: "è¡¨ç¤ºã€Œæœ‰...çš„ã€ï¼Œæ“æœ‰æŸç‰¹å¾µæˆ–ç‰©å“ï¼Œä½¿ç”¨ä»‹ç³»è© withã€‚",
            8: "è¡¨ç¤ºã€Œæ²’æœ‰...çš„ã€ï¼Œä¸å…·æœ‰æŸç‰¹å¾µæˆ–ç‰©å“ï¼Œä½¿ç”¨ä»‹ç³»è© withoutã€‚",
            9: "ç›´æ¥å°‡ã€Œä¸»èª+å‹•è©ã€çš„å®Œæ•´å¥å­æ”¾åœ¨åè©å¾Œæ–¹ä¿®é£¾ã€‚",
            10: "é€™å±¬æ–¼ã€Œè¤‡åˆå½¢å®¹è©ã€ï¼Œä½¿ç”¨å½¢å®¹è©æ­é…ä»‹ç³»è© (å¦‚ fond of, full of ç­‰) æ”¾åœ¨åè©å¾Œæ–¹ã€‚",
            11: "å°‡æ™‚é–“è©å¾Œç½®åœ¨åè©å¾Œæ–¹ä¿®é£¾ (å¦‚ in the past, tomorrow)ã€‚",
            12: "å°‡åœ°æ–¹å‰¯è©æˆ–ä»‹ç³»è©ç‰‡èªå¾Œç½®åœ¨åè©å¾Œæ–¹ä¿®é£¾ (å¦‚ there, on the table)ã€‚",
            13: "è¡¨ç¤ºå…§å®¹é—œæ–¼æŸäº‹ç‰©ï¼Œä½¿ç”¨ aboutã€‚",
            14: "è¡¨ç¤ºè¢«å‹•å‹•ä½œ (å¦‚è¢«ç¨±ç‚ºã€è¢«è£½é€ )ï¼Œç›´æ¥å°‡éå»åˆ†è© (p.p.) æ”¾åœ¨åè©å¾Œæ–¹ã€‚"
        };

        // ------------------------------------------------------------------
        // 2. é¡Œåº«è³‡æ–™ (140é¡Œ) 
        // ------------------------------------------------------------------
        const questionBank = [
            // Rule 1: äººç¨± 's
            { rule: 1, chinese: "æˆ‘çš„æœ‹å‹çš„æ›¸", correct_tokens: [ ["my", "friend's", "book"] ] },
            { rule: 1, chinese: "å½¼å¾—çš„è»Š", correct_tokens: [ ["Peter's", "car"] ] },
            { rule: 1, chinese: "é‚£å€‹è€å¸«çš„å»ºè­°", correct_tokens: [ ["the", "teacher's", "advice"] ] },
            { rule: 1, chinese: "åª½åª½çš„ç¦®ç‰©", correct_tokens: [ ["mom's", "gift"] ] },
            { rule: 1, chinese: "ç‘ªè‰çš„æˆ¿é–“", correct_tokens: [ ["Mary's", "room"] ] },
            { rule: 1, chinese: "é‚£å€‹ç”·å­©çš„ç©å…·", correct_tokens: [ ["that", "boy's", "toy"] ] },
            { rule: 1, chinese: "æˆ‘å€‘è€é—†çš„æ±ºå®š", correct_tokens: [ ["our", "boss's", "decision"] ] },
            { rule: 1, chinese: "ç´„ç¿°çš„é›»è…¦", correct_tokens: [ ["John's", "computer"] ] },
            { rule: 1, chinese: "é€™å¥³äººçš„æ‰‹è¢‹", correct_tokens: [ ["this", "woman's", "handbag"] ] },
            { rule: 1, chinese: "é€™äº›å­¸ç”Ÿçš„ç­†", correct_tokens: [ ["these", "students'", "pens"] ] },

            // Rule 2: å‹•ç‰©/åœ°æ–¹ 's
            { rule: 2, chinese: "å°ç£çš„æ–‡åŒ–", correct_tokens: [ ["Taiwan's", "culture"] ] },
            { rule: 2, chinese: "é‚£éš»ç‹—çš„å°¾å·´", correct_tokens: [ ["the", "dog's", "tail"] ] },
            { rule: 2, chinese: "é¦™æ¸¯çš„ç¶“æ¿Ÿ", correct_tokens: [ ["Hong", "Kong's", "economy"] ] },
            { rule: 2, chinese: "è²“çš„çœ¼ç›", correct_tokens: [ ["the", "cat's", "eyes"] ] },
            { rule: 2, chinese: "ä¸–ç•Œçš„å’Œå¹³", correct_tokens: [ ["the", "world's", "peace"] ] },
            { rule: 2, chinese: "å…¬å¸çš„åˆ©æ½¤", correct_tokens: [ ["the", "company's", "profit"] ] },
            { rule: 2, chinese: "åŸå¸‚çš„ç™¼å±•", correct_tokens: [ ["the", "city's", "development"] ] },
            { rule: 2, chinese: "ç…å­çš„å¼è²", correct_tokens: [ ["the", "lion's", "roar"] ] },
            { rule: 2, chinese: "æˆ‘å€‘çš„å­¸æ ¡çš„è¦å®š", correct_tokens: [ ["our", "school's", "rules"] ] },
            { rule: 2, chinese: "æ—¥æœ¬çš„æ­·å²", correct_tokens: [ ["Japan's", "history"] ] },

            // Rule 3: æ•¸å­—+é‡è©+çš„
            { rule: 3, chinese: "ä¸€åº§äº”å±¤é«˜çš„å»ºç¯‰ç‰©", correct_tokens: [ ["a", "five-storey", "building"], ["a", "5-storey", "building"] ] },
            { rule: 3, chinese: "ä¸€å€‹åæ­²çš„ç”·å­©", correct_tokens: [ ["a", "ten-year-old", "boy"], ["a", "10-year-old", "boy"] ] },
            { rule: 3, chinese: "ä¸€å¼µä¸€ç™¾å…ƒçš„éˆ”ç¥¨", correct_tokens: [ ["a", "one-hundred-dollar", "bill"], ["a", "100-dollar", "bill"] ] },
            { rule: 3, chinese: "ä¸€å€‹å…©å°æ™‚çš„æœƒè­°", correct_tokens: [ ["a", "two-hour", "meeting"], ["a", "2-hour", "meeting"] ] },
            { rule: 3, chinese: "ä¸€æ®µä¸‰å…¬é‡Œçš„è·¯ç¨‹", correct_tokens: [ ["a", "three-kilometer", "journey"], ["a", "3-kilometer", "journey"] ] },
            { rule: 3, chinese: "ä¸€å€‹å››æ˜Ÿç´šçš„é…’åº—", correct_tokens: [ ["a", "four-star", "hotel"], ["a", "4-star", "hotel"] ] },
            { rule: 3, chinese: "ä¸€ä»½äº”é çš„å ±å‘Š", correct_tokens: [ ["a", "five-page", "report"], ["a", "5-page", "report"] ] },
            { rule: 3, chinese: "ä¸€å€‹å…­äººçš„åœ˜éšŠ", correct_tokens: [ ["a", "six-person", "team"], ["a", "6-person", "team"] ] },
            { rule: 3, chinese: "ä¸€æ®µååˆ†é˜çš„ä¼‘æ¯", correct_tokens: [ ["a", "ten-minute", "break"], ["a", "10-minute", "break"] ] },
            { rule: 3, chinese: "ä¸€å€‹ä¸ƒå¤©çš„å‡æœŸ", correct_tokens: [ ["a", "seven-day", "holiday"], ["a", "7-day", "holiday"] ] },

            // Rule 4: ç„¡ç”Ÿå‘½çš„ of
            { rule: 4, chinese: "é€™å€‹è¢‹å­çš„åƒ¹æ ¼", correct_tokens: [ ["the", "price", "of", "the", "bag"] ] },
            { rule: 4, chinese: "é€™æœ¬æ›¸çš„å°é¢", correct_tokens: [ ["the", "cover", "of", "the", "book"] ] },
            { rule: 4, chinese: "é€™é–“æˆ¿å­çš„å±‹é ‚", correct_tokens: [ ["the", "roof", "of", "the", "house"] ] },
            { rule: 4, chinese: "é€™å€‹é›»è…¦çš„å±å¹•", correct_tokens: [ ["the", "screen", "of", "the", "computer"] ] },
            { rule: 4, chinese: "é¦™æ¸¯çš„äººå£", correct_tokens: [ ["the", "population", "of", "Hong", "Kong"] ] },
            { rule: 4, chinese: "é€™é¦–æ­Œçš„åå­—", correct_tokens: [ ["the", "name", "of", "this", "song"] ] },
            { rule: 4, chinese: "é€™å¼µæ¡Œå­çš„é¡è‰²", correct_tokens: [ ["the", "color", "of", "this", "table"], ["the", "colour", "of", "this", "table"] ] },
            { rule: 4, chinese: "æˆåŠŸçš„é—œéµ", correct_tokens: [ ["the", "key", "to", "success"], ["the", "key", "of", "success"] ] },
            { rule: 4, chinese: "é€™å€‹å•é¡Œçš„åŸå› ", correct_tokens: [ ["the", "cause", "of", "the", "problem"] ] },
            { rule: 4, chinese: "é€™å€‹æ•…äº‹çš„çµå°¾", correct_tokens: [ ["the", "end", "of", "the", "story"] ] },

            // Rule 5: ä¸»å‹•å‹•è©
            { rule: 5, chinese: "ç¶“å¸¸å“­çš„é‚£å€‹ç”·å­©", correct_tokens: [ ["the", "boy", "who", "often", "cries"] ] },
            { rule: 5, chinese: "ä¸å–œæ­¡æˆ‘çš„é‚£å€‹è€å¸«", correct_tokens: [ ["the", "teacher", "who", "does", "not","like", "me"] ] },
            { rule: 5, chinese: "æ˜¨å¤©æ²’æœ‰ä¾†çš„å­¸ç”Ÿ", correct_tokens: [ ["students", "who", "did", "not","come", "yesterday"], ["the", "students", "who", "did", "not","come", "yesterday"] ] },
            { rule: 5, chinese: "ä½åœ¨éš”å£çš„é‚£å€‹å¥³äºº", correct_tokens: [ ["the", "woman", "who", "lives", "next", "door"] ] },
            { rule: 5, chinese: "å¾ˆå¤šéŠå®¢åƒè§€çš„é‚£å€‹åšç‰©é¤¨", correct_tokens: [ ["the", "museum", "which", "many", "tourists", "visit"], ["the", "museum", "that", "many", "tourists", "visit"] ] },
            { rule: 5, chinese: "æ­£åœ¨ç¡è¦ºçš„é‚£éš»è²“", correct_tokens: [ ["the", "cat", "which", "is", "sleeping"], ["the", "cat", "that", "is", "sleeping"] ] },
            { rule: 5, chinese: "æ­£åœ¨é‹è¡Œçš„é‚£å°æ©Ÿå™¨", correct_tokens: [ ["the", "machine", "which", "is", "running"], ["the", "machine", "that", "is", "running"] ] },
            { rule: 5, chinese: "æ•™è‹±æ–‡çš„é‚£ä½è€å¸«", correct_tokens: [ ["the", "teacher", "who", "teaches", "English"] ] },
            { rule: 5, chinese: "è£½é€ å™ªéŸ³çš„é‚£äº›ç‹—", correct_tokens: [ ["the", "dogs", "which", "make", "noise"], ["the", "dogs", "that", "make", "noise"] ] },
            { rule: 5, chinese: "å–œæ­¡éŸ³æ¨‚çš„é‚£äº›äºº", correct_tokens: [ ["the", "people", "who", "like", "music"], ["people", "who", "like", "music"] ] },
            { rule: 5, chinese: "è³£æ°´æœçš„é‚£å®¶åº—", correct_tokens: [ ["the", "shop", "which", "sells", "fruit"], ["the", "shop", "that", "sells", "fruit"] ] },
            { rule: 5, chinese: "é–‹å¾—å¾ˆå¿«çš„é‚£è¼›è»Š", correct_tokens: [ ["the", "car", "which", "drives", "very", "fast"], ["the", "car", "that", "drives", "very", "fast"] ] },

            // Rule 6: Modal verb
            { rule: 6, chinese: "ä¸€å€‹å”±å¾—å¾ˆå¥½çš„å¥³å­©", correct_tokens: [ ["a", "girl", "who", "can", "sing", "well"] ] },
            { rule: 6, chinese: "ä¸€å€‹æ‡‰è©²è¢«æ‡²ç½°çš„å­¸ç”Ÿ", correct_tokens: [ ["a", "student", "who", "should", "be", "punished"] ] },
            { rule: 6, chinese: "ä¸€å€‹å°‡æœƒæˆåŠŸçš„è¨ˆåŠƒ", correct_tokens: [ ["a", "plan", "that", "will", "succeed"], ["a", "plan", "which", "will", "succeed"] ] },
            { rule: 6, chinese: "ä¸€å€‹å¯èƒ½ä¸‹é›¨çš„æ—¥å­", correct_tokens: [ ["a", "day", "which", "may", "rain"], ["a", "day", "that", "may", "rain"] ] },
            { rule: 6, chinese: "ä¸€å€‹å¿…é ˆåŠªåŠ›å·¥ä½œçš„äºº", correct_tokens: [ ["a", "person", "who", "must", "work", "hard"] ] },
            { rule: 6, chinese: "ä¸€å€‹å¯ä»¥å¹«åŠ©ä½ çš„äºº", correct_tokens: [ ["someone", "who", "can", "help", "you"], ["a", "person", "who", "can", "help", "you"] ] },
            { rule: 6, chinese: "ä¸€å€‹å°‡æœƒæ”¹è®Šä¸–ç•Œçš„æƒ³æ³•", correct_tokens: [ ["an", "idea", "that", "will", "change", "the", "world"], ["an", "idea", "which", "will", "change", "the", "world"] ] },
            { rule: 6, chinese: "ä¸€å€‹æ‡‰è©²æ›´å°å¿ƒçš„å¸æ©Ÿ", correct_tokens: [ ["a", "driver", "who", "should", "be", "more", "careful"] ] },
            { rule: 6, chinese: "ä¸€å€‹å¯èƒ½æœƒé²åˆ°çš„å®¢äºº", correct_tokens: [ ["a", "guest", "who", "might", "be", "late"] ] },
            { rule: 6, chinese: "ä¸€å€‹å¿…é ˆéµå®ˆè¦å‰‡çš„çƒå“¡", correct_tokens: [ ["a", "player", "who", "must", "follow", "the", "rules"] ] },

            // Rule 7: With
            { rule: 7, chinese: "ä¸€å€‹æœ‰é•·é ­é«®çš„å¥³å­©", correct_tokens: [ ["a", "girl", "with", "long", "hair"] ] },
            { rule: 7, chinese: "ä¸€é–“æœ‰å¤§èŠ±åœ’çš„å±‹", correct_tokens: [ ["a", "house", "with", "a", "big", "garden"] ] },
            { rule: 7, chinese: "ä¸€å€‹æœ‰è—çœ¼ç›çš„å¬°å…’", correct_tokens: [ ["a", "baby", "with", "blue", "eyes"] ] },
            { rule: 7, chinese: "ä¸€æœ¬æœ‰è¨±å¤šåœ–ç‰‡çš„æ›¸", correct_tokens: [ ["a", "book", "with", "many", "pictures"] ] },
            { rule: 7, chinese: "ä¸€å€‹æœ‰è±å¯Œç¶“é©—çš„äºº", correct_tokens: [ ["a", "person", "with", "rich", "experience"] ] },
            { rule: 7, chinese: "ä¸€å¼µæœ‰èŠ±ç´‹çš„æ¡Œå­", correct_tokens: [ ["a", "table", "with", "floral", "patterns"] ] },
            { rule: 7, chinese: "ä¸€ä»¶æœ‰ç´…è‰²æ¢ç´‹çš„è¥¯è¡«", correct_tokens: [ ["a", "shirt", "with", "red", "stripes"] ] },
            { rule: 7, chinese: "ä¸€å€‹æœ‰å¤§é¼»å­çš„äºº", correct_tokens: [ ["a", "person", "with", "a", "big", "nose"] ] },
            { rule: 7, chinese: "ä¸€éƒ¨æœ‰é«˜è§£åƒåº¦å±å¹•çš„æ‰‹æ©Ÿ", correct_tokens: [ ["a", "phone", "with", "a", "high", "resolution", "screen"] ] },
            { rule: 7, chinese: "ä¸€å€‹æœ‰å¹½é»˜æ„Ÿçš„æœ‹å‹", correct_tokens: [ ["a", "friend", "with", "a", "sense", "of", "humor"], ["a", "friend", "with", "a", "sense", "of", "humour"] ] },

            // Rule 8: Without
            { rule: 8, chinese: "ä¸€å€‹æ²’æœ‰å‹‡æ°£çš„äºº", correct_tokens: [ ["a", "man", "without", "courage"], ["a", "person", "without", "courage"] ] },
            { rule: 8, chinese: "ä¸€æ¯æ²’æœ‰ç³–çš„å’–å•¡", correct_tokens: [ ["a", "cup", "of", "coffee", "without", "sugar"] ] },
            { rule: 8, chinese: "ä¸€å€‹æ²’æœ‰çª—æˆ¶çš„æˆ¿é–“", correct_tokens: [ ["a", "room", "without", "windows"] ] },
            { rule: 8, chinese: "ä¸€å€‹æ²’æœ‰åå­—çš„åŸå¸‚", correct_tokens: [ ["a", "city", "without", "a", "name"] ] },
            { rule: 8, chinese: "ä¸€æ®µæ²’æœ‰è¡—ç‡ˆçš„è·¯", correct_tokens: [ ["a", "road", "without", "streetlights"] ] },
            { rule: 8, chinese: "ä¸€å€‹æ²’æœ‰æ‰‹æ©Ÿçš„å­¸ç”Ÿ", correct_tokens: [ ["a", "student", "without", "a", "mobile", "phone"], ["a", "student", "without", "a", "phone"] ] },
            { rule: 8, chinese: "ä¸€éš»æ²’æœ‰å°¾å·´çš„è²“", correct_tokens: [ ["a", "cat", "without", "a", "tail"] ] },
            { rule: 8, chinese: "ä¸€å€‹æ²’æœ‰ç†ç”±çš„æ±ºå®š", correct_tokens: [ ["a", "decision", "without", "a", "reason"] ] },
            { rule: 8, chinese: "ä¸€å€‹æ²’æœ‰ç¶“é©—çš„å·¥äºº", correct_tokens: [ ["a", "worker", "without", "experience"] ] },
            { rule: 8, chinese: "ä¸€å€‹æ²’æœ‰æœ‹å‹çš„å°å­©", correct_tokens: [ ["a", "child", "without", "friends"] ] },

            // Rule 9: å¥å­+çš„
            { rule: 9, chinese: "æ¯å€‹äººéƒ½å–œæ­¡çš„é‚£å€‹æ­Œæ‰‹", correct_tokens: [ ["the", "singer", "everyone", "likes"], ["the", "singer", "who", "everyone", "likes"] ] },
            { rule: 9, chinese: "æˆ‘æ˜¨å¤©è²·çš„é‚£æœ¬æ›¸", correct_tokens: [ ["the", "book", "I", "bought", "yesterday"], ["the", "book", "which", "I", "bought", "yesterday"] ] },
            { rule: 9, chinese: "æˆ‘å€‘æ­£åœ¨è«‡è«–çš„é‚£éƒ¨é›»å½±", correct_tokens: [ ["the", "movie", "we", "are", "talking", "about"], ["the", "movie", "which", "we", "are", "talking", "about"] ] },
            { rule: 9, chinese: "ä½ çµ¦æˆ‘çš„é‚£å€‹ç¦®ç‰©", correct_tokens: [ ["the", "gift", "you", "gave", "me"], ["the", "gift", "which", "you", "gave", "me"] ] },
            { rule: 9, chinese: "æˆ‘æƒ³å»çš„åœ°æ–¹", correct_tokens: [ ["the", "place", "I", "want", "to", "go"], ["the", "place", "where", "I", "want", "to", "go"] ] },
            { rule: 9, chinese: "ä»–å‘Šè¨´æˆ‘çš„é‚£å€‹æ•…äº‹", correct_tokens: [ ["the", "story", "he", "told", "me"], ["the", "story", "which", "he", "told", "me"] ] },
            { rule: 9, chinese: "ä½ åšçš„é£Ÿç‰©", correct_tokens: [ ["the", "food", "you", "cooked"], ["the", "food", "which", "you", "cooked"] ] },
            { rule: 9, chinese: "æˆ‘èªè­˜çš„é‚£å€‹äºº", correct_tokens: [ ["the", "person", "I", "know"], ["the", "person", "who", "I", "know"] ] },
            { rule: 9, chinese: "æˆ‘å€‘ä½çš„æˆ¿å­", correct_tokens: [ ["the", "house", "we", "live", "in"], ["the", "house", "which", "we", "live", "in"] ] },
            { rule: 9, chinese: "ä½ æ­£åœ¨å°‹æ‰¾çš„ç­”æ¡ˆ", correct_tokens: [ ["the", "answer", "you", "are", "looking", "for"], ["the", "answer", "which", "you", "are", "looking", "for"] ] },

            // Rule 10: è¤‡åˆå½¢å®¹è©+çš„
            { rule: 10, chinese: "ä¸€å€‹ç†±æ„›å”±æ­Œçš„å¥³å­©", correct_tokens: [ ["a", "girl", "fond", "of", "singing"], ["a", "girl", "who", "is", "fond", "of", "singing"] ] },
            { rule: 10, chinese: "ä¸€æœ¬å……æ»¿åœ–ç‰‡çš„æ›¸", correct_tokens: [ ["a", "book", "full", "of", "pictures"], ["a", "book", "which", "is", "full", "of", "pictures"] ] },
            { rule: 10, chinese: "ä¸€å€‹å°é›»è…¦ç†Ÿæ‚‰çš„ç”·å­©", correct_tokens: [ ["a", "boy", "familiar", "with", "computers"], ["a", "boy", "who", "is", "familiar", "with", "computers"] ] },
            { rule: 10, chinese: "ä¸€å€‹å°å¥åº·æœ‰å®³çš„ç¿’æ…£", correct_tokens: [ ["a", "habit", "harmful", "to", "health"], ["a", "habit", "which", "is", "harmful", "to", "health"] ] },
            { rule: 10, chinese: "ä¸€å€‹å°æ¯å€‹äººéƒ½å‹å–„çš„äºº", correct_tokens: [ ["a", "person", "friendly", "to", "everyone"], ["a", "person", "who", "is", "friendly", "to", "everyone"] ] },
            { rule: 10, chinese: "ä¸€å€‹å¯ä»¥ä½¿ç”¨çš„æˆ¿é–“", correct_tokens: [ ["a", "room", "available", "for", "use"], ["a", "room", "which", "is", "available", "for", "use"] ] },
            { rule: 10, chinese: "ä¸€å€‹å°é€™å€‹æè­°æ„Ÿèˆˆè¶£çš„äºº", correct_tokens: [ ["a", "person", "interested", "in", "the", "proposal"], ["a", "person", "who", "is", "interested", "in", "the", "proposal"] ] },
            { rule: 10, chinese: "ä¸€å€‹èƒ½å¤ åšé€™é …å·¥ä½œçš„äºº", correct_tokens: [ ["a", "person", "capable", "of", "doing", "the", "job"], ["a", "person", "who", "is", "capable", "of", "doing", "the", "job"] ] },
            { rule: 10, chinese: "ä¸€å€‹å°é€™å€‹é …ç›®è² è²¬çš„ç¶“ç†", correct_tokens: [ ["a", "manager", "responsible", "for", "the", "project"], ["a", "manager", "who", "is", "responsible", "for", "the", "project"] ] },
            { rule: 10, chinese: "ä¸€å€‹é¡ä¼¼æ–¼æˆ‘çš„æƒ³æ³•", correct_tokens: [ ["an", "idea", "similar", "to", "mine"], ["an", "idea", "which", "is", "similar", "to", "mine"] ] },

            // Rule 11: æ™‚é–“è©
            { rule: 11, chinese: "éå»çš„äººå€‘", correct_tokens: [ ["people", "in", "the", "past"] ] },
            { rule: 11, chinese: "æ˜å¤©çš„é‚£å€‹æœƒè­°", correct_tokens: [ ["the", "meeting", "tomorrow"] ] },
            { rule: 11, chinese: "ä»Šå¤©çš„é‚£ä»½å ±ç´™", correct_tokens: [ ["the", "newspaper", "today"] ] },
            { rule: 11, chinese: "æ˜¨å¤©çš„æ´¾å°", correct_tokens: [ ["the", "party", "yesterday"] ] },
            { rule: 11, chinese: "å°‡ä¾†çš„ä¸–ç•Œ", correct_tokens: [ ["the", "world", "in", "the", "future"] ] },
            { rule: 11, chinese: "ä»Šæ™šçš„æ™šé¤", correct_tokens: [ ["the", "dinner", "tonight"] ] },
            { rule: 11, chinese: "ç¾åœ¨çš„å­¸ç”Ÿ", correct_tokens: [ ["students", "nowadays"], ["students", "now"] ] },
            { rule: 11, chinese: "æ—©ä¸Šçš„èª²", correct_tokens: [ ["the", "class", "in", "the", "morning"] ] },
            { rule: 11, chinese: "2020å¹´çš„å¥§é‹æœƒ", correct_tokens: [ ["the", "Olympics", "in", "2020"] ] },
            { rule: 11, chinese: "é€±æ—¥çš„é‡é¤", correct_tokens: [ ["the", "picnic", "on", "Sunday"] ] },

            // Rule 12: åœ°é»è©
            { rule: 12, chinese: "é‚£è£¡çš„äºº", correct_tokens: [ ["the", "people", "there"], ["people", "there"] ] },
            { rule: 12, chinese: "é€™è£¡çš„é£Ÿç‰©", correct_tokens: [ ["the", "food", "here"], ["food", "here"] ] },
            { rule: 12, chinese: "æµ·å¤–çš„å­¸ç”Ÿ", correct_tokens: [ ["students", "overseas"] ] },
            { rule: 12, chinese: "åœ‹å¤–çš„æœ‹å‹", correct_tokens: [ ["friends", "abroad"] ] },
            { rule: 12, chinese: "æ¨“ä¸Šçš„é‚£å€‹æˆ¿é–“", correct_tokens: [ ["the", "room", "upstairs"] ] },
            { rule: 12, chinese: "æ¨“ä¸‹çš„é‚£å€‹é„°å±…", correct_tokens: [ ["the", "neighbor", "downstairs"], ["the", "neighbour", "downstairs"] ] },
            { rule: 12, chinese: "é™„è¿‘çš„é‚£å€‹å…¬åœ’", correct_tokens: [ ["the", "park", "nearby"] ] },
            { rule: 12, chinese: "åœ¨æ¡Œä¸Šçš„é‚£æœ¬æ›¸", correct_tokens: [ ["the", "book", "on", "the", "table"], ["the", "book", "on", "the", "desk"] ] },
            { rule: 12, chinese: "åœ¨é¦™æ¸¯çš„å•†åº—", correct_tokens: [ ["shops", "in", "Hong", "Kong"] ] },
            { rule: 12, chinese: "åœ¨å®¶è£¡çš„ç”Ÿæ´»", correct_tokens: [ ["life", "at", "home"] ] },

            // Rule 13: About
            { rule: 13, chinese: "ä¸€æœ¬æœ‰é—œä¸­åœ‹çš„æ›¸", correct_tokens: [ ["a", "book", "about", "China"] ] },
            { rule: 13, chinese: "ä¸€å€‹é—œæ–¼æœªä¾†çš„è¨è«–", correct_tokens: [ ["a", "discussion", "about", "the", "future"] ] },
            { rule: 13, chinese: "ä¸€å€‹é—œæ–¼æ„›çš„æ•…äº‹", correct_tokens: [ ["a", "story", "about", "love"] ] },
            { rule: 13, chinese: "ä¸€éƒ¨é—œæ–¼æˆ°çˆ­çš„é›»å½±", correct_tokens: [ ["a", "movie", "about", "wars"], ["a", "movie", "about", "war"], ["a", "film", "about", "war"] ] },
            { rule: 13, chinese: "ä¸€å‰‡é—œæ–¼å¤©æ°£çš„æ–°è", correct_tokens: [ ["news", "about", "the", "weather"] ] },
            { rule: 13, chinese: "ä¸€å€‹é—œæ–¼å¥åº·çš„ç¯€ç›®", correct_tokens: [ ["a", "program", "about", "health"], ["a", "programme", "about", "health"] ] },
            { rule: 13, chinese: "ä¸€å ´é—œæ–¼æ”¿æ²»çš„è¾¯è«–", correct_tokens: [ ["a", "debate", "about", "politics"] ] },
            { rule: 13, chinese: "ä¸€ç¯‡é—œæ–¼æ­·å²çš„æ–‡ç« ", correct_tokens: [ ["an", "article", "about", "history"] ] },
            { rule: 13, chinese: "ä¸€å€‹é—œæ–¼ç§‘å­¸çš„å•é¡Œ", correct_tokens: [ ["a", "question", "about", "science"] ] },
            { rule: 13, chinese: "ä¸€å€‹é—œæ–¼å®‰å…¨çš„æ“”æ†‚", correct_tokens: [ ["a", "worry", "about", "safety"], ["a", "concern", "about", "safety"] ] },

            // Rule 14: è¢«å‹•å‹•è© (PP)
            { rule: 14, chinese: "ä¸€å€‹è¢«ç¨±ç‚ºå®™æ–¯çš„ç”·äºº", correct_tokens: [ ["a", "man", "called", "Zeus"] ] },
            { rule: 14, chinese: "ä¸€ä»½æœªè¢«è€é—†æ‰¹å‡†çš„æè­°", correct_tokens: [ ["a", "proposal", "not", "approved", "by", "the", "boss"] ] },
            { rule: 14, chinese: "ä¸€æœ¬ç”¨è‹±èªå¯«çš„æ›¸", correct_tokens: [ ["a", "book", "written", "in", "English"] ] },
            { rule: 14, chinese: "ä¸€å€‹è¢«é‚€è«‹åƒåŠ æ´¾å°çš„å®¢äºº", correct_tokens: [ ["a", "guest", "invited", "to", "the", "party"] ] },
            { rule: 14, chinese: "ä¸€è¼›æ—¥æœ¬è£½é€ çš„è»Š", correct_tokens: [ ["a", "car", "made", "in", "Japan"] ] },
            { rule: 14, chinese: "ä¸€å€‹è¢«è­¦å¯ŸæŠ“ä½çš„å°å·", correct_tokens: [ ["a", "thief", "caught", "by", "the", "police"] ] },
            { rule: 14, chinese: "ä¸€å°å¯„çµ¦ç‘ªè‰çš„ä¿¡", correct_tokens: [ ["a", "letter", "sent", "to", "Mary"] ] },
            { rule: 14, chinese: "ä¸€å€‹è¢«å¾ˆå¤šäººæ„›æˆ´çš„é ˜è¢–", correct_tokens: [ ["a", "leader", "loved", "by", "many", "people"] ] },
            { rule: 14, chinese: "ä¸€é–“è¢«ç«ç‡’æ¯€çš„æˆ¿å­", correct_tokens: [ ["a", "house", "destroyed", "by", "fire"] ] },
            { rule: 14, chinese: "ä¸€å€‹æœªè§£æ±ºçš„å•é¡Œ", correct_tokens: [ ["a", "problem", "not", "solved"], ["an", "unsolved", "problem"] ] }
        ];

        // ------------------------------------------------------------------
        // 3. éŠæˆ²ç‹€æ…‹èˆ‡ DOM
        // ------------------------------------------------------------------
        let currentQIndex = 0;
        let score = 0;
        let currentQ = null;
        let shuffledQuestions = [];
        let gameHistory = []; 
        let currentPhase = 1; // 1 = é¸æ“‡åˆ†é¡, 2 = å¯«å¥å­
        
        // Timer
        let timeLeft = 30;
        let timerInterval = null;
        let defaultPhase1Time = 30;
        let defaultPhase2Time = 40;
        
        const dom = {
            gameArea: document.getElementById('game-area'),
            endScreen: document.getElementById('end-screen'),
            qCurrent: document.getElementById('q-current'),
            qTotal: document.getElementById('q-total'),
            timerBar: document.getElementById('timer-bar'),
            timerText: document.getElementById('timer-text'),
            score: document.getElementById('score'),
            chineseDisplay: document.getElementById('chinese-display'),
            categoryGrid: document.getElementById('category-grid'),
            typingArea: document.getElementById('typing-area'),
            englishInput: document.getElementById('english-input'),
            submitSentenceBtn: document.getElementById('submit-sentence-btn'),
            feedbackArea: document.getElementById('feedback-area'),
            nextBtn: document.getElementById('next-btn'),
            backBtn: document.getElementById('back-btn')
        };

        // éŸ³æ•ˆç³»çµ±
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }
        function playBeep(freq = 800, dur = 0.1) { playTone(freq, 'sine', dur); }

        const sfx = {
            click: () => playTone(600, 'triangle', 0.05),
            correct: () => { playTone(660, 'square', 0.1); setTimeout(() => playTone(880, 'square', 0.2), 100); },
            wrong: () => playTone(200, 'sawtooth', 0.3),
            win: () => { playTone(440, 'sine', 0.1); setTimeout(() => playTone(554, 'sine', 0.1), 100); setTimeout(() => playTone(659, 'sine', 0.2), 200); },
            countdown: () => playBeep(880, 0.1),
            timeup: () => playTone(150, 'sawtooth', 0.5)
        };

        // ------------------------------------------------------------------
        // 4. éŠæˆ²é‚è¼¯
        // ------------------------------------------------------------------
        
        function initGame(isRetry = false) {
            currentQIndex = 0;
            score = 0;
            gameHistory = [];
            
            dom.endScreen.style.display = 'none';
            dom.gameArea.style.display = 'block';

            if (!isRetry) {
                shuffledQuestions = [...questionBank].sort(() => Math.random() - 0.5).slice(0, 10);
            } 

            dom.qTotal.innerText = shuffledQuestions.length;
            renderCategories();
            loadQuestion();
        }

        function renderCategories() {
            dom.categoryGrid.innerHTML = '';
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerText = cat.name;
                btn.onclick = () => handleCategoryClick(cat.id, cat.name);
                dom.categoryGrid.appendChild(btn);
            });
        }

        function loadQuestion() {
            if (currentQIndex >= shuffledQuestions.length) {
                endGame();
                return;
            }

            currentPhase = 1;
            currentQ = shuffledQuestions[currentQIndex];
            
            dom.qCurrent.innerText = currentQIndex + 1;
            dom.score.innerText = score;
            dom.chineseDisplay.innerText = currentQ.chinese;
            
            // é‡ç½® UI ç‹€æ…‹
            dom.categoryGrid.style.display = 'grid';
            Array.from(dom.categoryGrid.children).forEach(btn => btn.disabled = false);
            dom.typingArea.style.display = 'none';
            dom.englishInput.value = '';
            dom.englishInput.disabled = false;
            
            dom.submitSentenceBtn.style.display = 'block';
            dom.submitSentenceBtn.disabled = false;
            dom.submitSentenceBtn.innerText = "æäº¤å¥å­";
            
            dom.feedbackArea.innerHTML = '';
            dom.nextBtn.style.display = 'none';
            dom.backBtn.style.display = 'inline-block';

            startTimer(defaultPhase1Time);
        }

        function startTimer(seconds) {
            clearInterval(timerInterval);
            timeLeft = seconds; 
            updateTimerUI();
            
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                
                if (timeLeft <= 3.0 && timeLeft > 0) {
                    if (Math.abs(timeLeft % 1) < 0.1) sfx.countdown();
                }

                if (timeLeft <= 0) {
                    timeLeft = 0;
                    handleTimeout();
                }
                updateTimerUI();
            }, 100);
        }

        function stopTimer() { clearInterval(timerInterval); }

        function updateTimerUI() {
            dom.timerText.innerText = Math.abs(timeLeft).toFixed(1);
            let totalTime = currentPhase === 1 ? defaultPhase1Time : defaultPhase2Time;
            let pct = (timeLeft / totalTime) * 100;
            dom.timerBar.style.width = `${pct}%`;
            
            if (timeLeft <= 5) dom.timerBar.style.backgroundColor = 'var(--danger-color)';
            else dom.timerBar.style.backgroundColor = 'var(--primary-color)';
        }

        function handleTimeout() {
            stopTimer();
            sfx.timeup();
            
            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let correctAnsStr = currentQ.correct_tokens[0].join(' ');
            
            if (currentPhase === 1) {
                Array.from(dom.categoryGrid.children).forEach(btn => btn.disabled = true);
                showFeedback(false, `â° æ™‚é–“åˆ°ï¼<br>æ­£ç¢ºåˆ†é¡: <strong>${correctCatName}</strong><br>æ­£ç¢ºå¥å­: <strong>${correctAnsStr}</strong>`);
                recordHistory(false, "Timeout", false, "Timeout", false);
                showNextBtn();
            } else {
                dom.submitSentenceBtn.style.display = 'none';
                dom.englishInput.disabled = true;
                showFeedback(false, `â° æ™‚é–“åˆ°ï¼<br>æ­£ç¢ºå¥å­: <strong>${correctAnsStr}</strong>`);
                recordHistory(true, correctCatName, false, "Timeout", false);
                showNextBtn();
            }
        }

        // --- éšæ®µä¸€ï¼šåˆ¤æ–·åˆ†é¡ ---
        function handleCategoryClick(selectedId, selectedName) {
            sfx.click();
            stopTimer();
            Array.from(dom.categoryGrid.children).forEach(btn => btn.disabled = true);

            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let correctAnsStr = currentQ.correct_tokens[0].join(' ');
            let explanation = ruleExplanations[currentQ.rule];

            if (selectedId === correctCatId) {
                // ç­”å°äº†
                score += 5;
                dom.score.innerText = score;
                sfx.correct();
                
                dom.categoryGrid.style.display = 'none';
                dom.typingArea.style.display = 'flex';
                dom.englishInput.focus();
                dom.backBtn.style.display = 'none';
                
                currentPhase = 2;
                startTimer(defaultPhase2Time); 
            } else {
                // ç­”éŒ¯äº†
                sfx.wrong();
                let msg = `âŒ é¸æ“‡éŒ¯èª¤ï¼<br>
                           æ­£ç¢ºåˆ†é¡æ˜¯ï¼š<strong>${correctCatName}</strong><br>
                           <div class="explanation-hint">ğŸ’¡ è§£é‡‹ï¼š${explanation}</div><br>
                           æ­£ç¢ºå¥å­æ‡‰ç‚ºï¼š<strong>${correctAnsStr}</strong>`;
                showFeedback(false, msg);
                recordHistory(false, selectedName, false, "(æœªé€²å…¥)", false);
                showNextBtn();
            }
        }

        function formatTextForComparison(text) {
            return text.toLowerCase().trim().replace(/\s+/g, ' ').replace(/[.,!?;]*$/, '');
        }

        // --- éšæ®µäºŒï¼šæª¢æŸ¥è¼¸å…¥çš„å¥å­ (æ•´åˆ AI) ---
        async function checkSentence() {
            if (dom.submitSentenceBtn.disabled) return;
            
            sfx.click();
            stopTimer();

            const userTyping = dom.englishInput.value;
            const formattedUserInput = formatTextForComparison(userTyping);
            
            // å°‡æ‰€æœ‰æ­£ç¢ºç­”æ¡ˆçš„é™£åˆ—è½‰æ›ç‚ºå¯æ¯”è¼ƒçš„å­—ä¸²
            const correctAnswers = currentQ.correct_tokens.map(arr => arr.join(' '));
            const formattedCorrectAnswers = correctAnswers.map(formatTextForComparison);
            
            let isMatch = formattedCorrectAnswers.includes(formattedUserInput);
            let usedAI = false;
            
            // é–å®šæŒ‰éˆ•èˆ‡è¼¸å…¥æ¡†
            dom.submitSentenceBtn.disabled = true;
            dom.englishInput.disabled = true;

            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let ruleDesc = ruleExplanations[currentQ.rule];

            // å¦‚æœæœ¬åœ°æ²’å°ä¸Šï¼Œä¸”å­¸ç”Ÿæœ‰è¼¸å…¥æ±è¥¿ï¼Œå°±äº¤çµ¦ AI åˆ¤æ–·
            if (!isMatch && formattedUserInput !== "") {
                usedAI = true;
                dom.submitSentenceBtn.innerText = "ğŸ¤– AI åˆ¤æ–·ä¸­...";
                isMatch = await checkAnswerWithAI(userTyping, currentQ.chinese, ruleDesc, correctAnswers[0]);
            }
            
            // åˆ¤æ–·å®Œç•¢ï¼Œéš±è—æŒ‰éˆ•
            dom.submitSentenceBtn.style.display = 'none';

            if (isMatch) {
                score += 5; // åŠ ä¸Šæ‰“å­—çš„ 5 åˆ†
                dom.score.innerText = score;
                
                let msg = usedAI ? "ğŸ‰ å®Œç¾ï¼AI èªå¯äº†ä½ çš„åŒç¾©è©/å¯«æ³•ï¼" : "ğŸ‰ å®Œç¾ï¼åˆ†é¡èˆ‡å¥å­å®Œå…¨æ­£ç¢ºï¼";
                let badge = usedAI ? `<span class="ai-badge">AI åˆ¤å®š</span>` : "";
                showFeedback(true, msg + badge);
                
                sfx.correct();
                recordHistory(true, correctCatName, true, userTyping, usedAI);
            } else {
                let badge = usedAI ? `<span class="ai-badge">AI åˆ¤å®š</span>` : "";
                showFeedback(false, `âŒ å¥å­æœ‰èª¤ï¼${badge}<br>æ¨™æº–å¯«æ³•: <strong>${correctAnswers[0]}</strong>`);
                sfx.wrong();
                recordHistory(true, correctCatName, false, userTyping, usedAI);
            }
            
            showNextBtn();
        }

        // ç´€éŒ„éŒ¯é¡Œèˆ‡æ­·å²
        function recordHistory(isCatCorrect, userCatName, isSentenceCorrect, userSentence, usedAI) {
            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let correctSentence = currentQ.correct_tokens[0].join(' ');
            let isCompletelyCorrect = isCatCorrect && isSentenceCorrect;

            gameHistory.push({
                originalObj: currentQ, 
                questionText: currentQ.chinese,
                isCorrect: isCompletelyCorrect,
                isCatCorrect: isCatCorrect,
                correctCatName: correctCatName,
                userCatName: userCatName,
                isSentenceCorrect: isSentenceCorrect,
                correctSentence: correctSentence,
                userSentence: userSentence,
                usedAI: usedAI,
                explanation: ruleExplanations[currentQ.rule]
            });
        }

        function showFeedback(isSuccess, msg) {
            let colorClass = isSuccess ? 'text-correct' : 'text-wrong';
            dom.feedbackArea.innerHTML = `<div class="feedback-text ${colorClass}">${msg}</div>`;
        }

        function showNextBtn() {
            dom.nextBtn.style.display = 'block';
            dom.backBtn.style.display = 'none';
        }

        function nextQuestion() {
            sfx.click();
            currentQIndex++;
            loadQuestion();
        }

        function retryWrongQuestions() {
            const wrongQuestions = gameHistory.filter(h => !h.isCorrect).map(h => h.originalObj);
            if (wrongQuestions.length === 0) {
                alert("æ²’æœ‰éŒ¯é¡Œå¯ä»¥é‡åšï¼");
                return;
            }
            shuffledQuestions = wrongQuestions;
            initGame(true);
        }

        function endGame() {
            stopTimer();
            dom.gameArea.style.display = 'none';
            dom.endScreen.style.display = 'block';
            sfx.win();

            const totalQ = shuffledQuestions.length;
            const percentage = Math.round((score / (totalQ * 10)) * 100); 

            const wrongAnswers = gameHistory.filter(h => !h.isCorrect);
            let analysisHTML = '';
            
            if (wrongAnswers.length > 0) {
                analysisHTML = `
                    <div class="error-analysis">
                        <h3 style="color:var(--danger-color)">éŒ¯èª¤è¤‡ç¿’ (${wrongAnswers.length} é¡Œ):</h3>
                        ${wrongAnswers.map(item => `
                            <div class="error-item">
                                <div style="margin-bottom:8px; font-weight:bold; color:#333;">é¡Œç›®: ${item.questionText}</div>
                                ${!item.isCatCorrect 
                                    ? `<div style="color:var(--danger-color)">âŒ <strong>åˆ†é¡éŒ¯èª¤:</strong> ä½ é¸äº† ${item.userCatName} (æ­£ç¢ºç‚º ${item.correctCatName})</div>`
                                    : `<div style="color:var(--success-color)">âœ… <strong>åˆ†é¡æ­£ç¢º:</strong> ${item.correctCatName}</div>`
                                }
                                ${!item.isSentenceCorrect && item.isCatCorrect
                                    ? `<div style="color:var(--danger-color)">âŒ <strong>å¥å­éŒ¯èª¤:</strong> ${item.userSentence} ${item.usedAI ? '<span class="ai-badge">AI åˆ¤å®š</span>' : ''}</div><div style="color:var(--primary-dark)"><strong>æ¨™æº–ç­”æ¡ˆ:</strong> ${item.correctSentence}</div>`
                                    : (!item.isCatCorrect ? `<div style="color:var(--primary-dark)"><strong>æ­£ç¢ºå¥å­:</strong> ${item.correctSentence}</div>` : "")
                                }
                                <div style="font-size:0.9em; color:#666; margin-top:5px; padding-top:5px; border-top:1px dashed #ccc;">ğŸ’¡ <strong>ç›¸é—œè¦å‰‡ï¼š</strong>${item.explanation}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                analysisHTML = `<h3 style="color:var(--secondary-dark); margin-top:30px;">å®Œç¾ï¼å…¨å°ï¼ğŸ‰</h3>`;
            }

            const retryBtnStyle = wrongAnswers.length > 0 ? "display:inline-block;" : "display:none;";

            dom.endScreen.innerHTML = `
                <div class="end-game-container">
                    <h1>Challenge Complete!</h1>
                    <div class="final-score">ç¸½å¾—åˆ†: ${score} / ${totalQ * 10} (${percentage}%)</div>
                    ${analysisHTML}
                    <div class="result-controls">
                        <button class="result-btn btn-menu" onclick="goBackToMenu()">è¿”å›é¸å–®</button>
                        <button class="result-btn btn-retry-wrong" style="${retryBtnStyle}" onclick="retryWrongQuestions()">é‡åšéŒ¯é¡Œ</button>
                        <button class="result-btn btn-restart" onclick="initGame()">å†ä¾†ä¸€æ¬¡</button>
                    </div>
                </div>
            `;
        }

        dom.submitSentenceBtn.addEventListener('click', checkSentence);
        dom.englishInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && currentPhase === 2 && !dom.englishInput.disabled && !dom.submitSentenceBtn.disabled) {
                if (dom.englishInput.value.trim() === '') {
                    alert("è«‹è¼¸å…¥è‹±æ–‡å¥å­ï¼");
                    return;
                }
                checkSentence();
            }
        });
        
        function goBackToMenu() {
            if (window.parent && window.parent.closeGame) {
                window.parent.closeGame();
            } else {
                window.location.href = 'eng_game123.html';
            }
        }

        // å•Ÿå‹•éŠæˆ²
        initGame();

    </script>
</body>
</html>
