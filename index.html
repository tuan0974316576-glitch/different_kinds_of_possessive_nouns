<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英文「的」文法挑戰</title>
    <style>
        /* --- 核心變數 --- */
        :root {
            --base-bg: #F1F3F3;       
            --primary-color: #0a9396;   
            --primary-dark: #005f73;    
            --secondary-color: #40916c; 
            --secondary-dark: #2d6a4f;  
            --light-bg-1: #e6eaea;      
            --light-bg-2: #e6f1f0;      
            --text-color: #212529;      
            --border-color: #ced4da;     
            --danger-color: #dc3545;     
            --success-color: #2d6a4f;
            --btn-correct: #2a9d8f;
            --btn-wrong: #e76f51;
            --ai-color: #9b59b6;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--base-bg); 
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #game-container {
            width: 100%;
            max-width: 900px;
            background-color: #ffffff;
            height: 100%; 
            border-radius: 0; 
            box-shadow: none;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        @media (min-width: 600px) {
            body {
                align-items: center;
                padding: 20px;
            }
            #game-container {
                height: auto;
                max-height: 95vh;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                border: 2px solid var(--border-color);
            }
        }

        h1 {
            text-align: center;
            color: var(--primary-dark); 
            margin-top: 5px;
            margin-bottom: 10px;
            font-size: 20px;
            font-weight: 800;
            flex-shrink: 0;
        }

        /* 狀態列 */
        #game-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #555;
            font-size: 14px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        /* 計時器樣式 */
        .timer-container {
            flex-grow: 1;
            margin: 0 15px;
            position: relative;
            height: 24px;
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #ccc;
        }

        #timer-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--primary-color);
            width: 100%;
            transition: width 0.1s linear, background-color 0.3s;
        }

        .timer-text {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-family: monospace;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            z-index: 2;
        }

        /* 題目顯示區 */
        #question-area {
            background-color: var(--light-bg-1);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            text-align: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        #chinese-display {
            font-size: 22px;
            color: #333;
            font-weight: bold;
            line-height: 1.3;
        }

        /* 第一部分：12宮格分類按鈕 */
        #category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            #category-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .category-btn {
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            background-color: white;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .category-btn:hover {
            border-color: var(--primary-color);
            background-color: var(--light-bg-2);
        }

        .category-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }

        /* 第二部分：文字輸入區 */
        #typing-area {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .typing-instruction {
            text-align: center;
            color: var(--success-color);
            font-weight: bold;
            font-size: 16px;
        }

        #english-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            box-sizing: border-box;
            background-color: #fff;
            color: #333;
        }

        #english-input:focus { border-color: var(--primary-color); outline: none; }
        #english-input:disabled { background-color: #e9ecef; color: #888; cursor: not-allowed; }

        #submit-sentence-btn {
            background-color: var(--primary-color);
            min-width: 150px;
            align-self: center;
            font-size: 18px;
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }
        
        #submit-sentence-btn:hover:not(:disabled) { background-color: var(--primary-dark); }
        
        #submit-sentence-btn:disabled {
            background-color: var(--ai-color);
            cursor: wait;
            animation: pulse-ai 1.5s infinite;
        }

        @keyframes pulse-ai {
            0% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(155, 89, 182, 0); }
            100% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); }
        }

        /* 反饋與控制 */
        #feedback-area {
            text-align: center;
            min-height: 50px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .feedback-text { font-size: 16px; font-weight: bold; line-height: 1.5; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box;}
        .text-correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .text-wrong { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; text-align: left; }
        .explanation-hint { font-size: 14px; color: #555; margin-top: 8px; font-weight: normal;}
        
        /* AI 徽章 */
        .ai-badge {
            display: inline-block;
            background-color: var(--ai-color);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 5px;
            vertical-align: middle;
        }

        #controls {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .control-btn {
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            min-width: 110px;
        }

        #next-btn { background-color: var(--primary-dark); display: none; margin-left: auto;}
        #back-btn { background-color: white; color: var(--primary-color); border: 2px solid var(--primary-color); transition: all 0.2s;}
        #back-btn:hover { background-color: var(--primary-color); color: white; }

        /* 遊戲結束畫面 */
        #end-screen { display: none; text-align: center; width: 100%; }
        .end-game-container { text-align: center; padding: 10px; }
        .final-score { font-size: 40px; font-weight: 900; color: var(--secondary-dark); margin: 20px 0; border: 4px solid var(--secondary-color); padding: 20px; display: inline-block; border-radius: 8px; background-color: var(--light-bg-2); }
        .error-analysis { margin-top: 30px; text-align: left; border-top: 2px solid var(--border-color); padding-top: 20px; max-height: 50vh; overflow-y: auto; }
        .error-item { margin-bottom: 15px; padding: 12px; border-left: 4px solid var(--danger-color); background-color: #fff5f5; border-radius: 4px; font-size: 15px;}
        .result-controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .result-btn { padding: 12px 20px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; min-width: 120px; border: 2px solid transparent; }
        .btn-menu { background-color: white; color: var(--primary-color); border-color: var(--primary-color); }
        .btn-menu:hover { background-color: var(--primary-color); color: white; }
        .btn-retry-wrong { background-color: #e9c46a; color: #333; border-color: #d4a373; }
        .btn-retry-wrong:hover { background-color: #e76f51; color: white; border-color: #e76f51; }
        .btn-restart { background-color: var(--secondary-dark); color: white; border-color: var(--secondary-dark); }
        .btn-restart:hover { background-color: var(--secondary-color); }
/* --- 新增：彈窗與主選單樣式 --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 1; transition: opacity 0.3s;
        }
        .modal-overlay.hidden { display: none; opacity: 0; pointer-events: none;}
        .modal-content {
            background: white; width: 90%; max-width: 500px;
            max-height: 85vh; border-radius: 20px; padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow-y: auto; position: relative; text-align: center;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .modal-title { font-size: 1.3rem; color: #333; font-weight: 800; margin: 0;}
        .close-btn { font-size: 2rem; cursor: pointer; color: #999; line-height: 1; margin-top: -5px;}
        .option-label {
            display: flex; align-items: center; gap: 8px; font-size: 14px;
            padding: 10px; background: #f8f9fa; border-radius: 8px; cursor: pointer;
            border: 1px solid #ddd; transition: all 0.2s;
        }
        .option-label:hover { background: #e9ecef; border-color: #bbb; }
        .option-checkbox { width: 16px; height: 16px; cursor: pointer; }
        @media (max-width: 600px) {
            #optionsContainer { grid-template-columns: 1fr !important; } /* 手機版變成單行 */
        }
    </style>
</head>
<body>

<div id="game-container">
        
        <div id="startOverlay" style="text-align: center; padding: 20px 10px;">
            <h2 style="color: var(--primary-dark); margin-bottom: 20px; font-size: 26px;">歡迎來到<br>英文「的」文法挑戰</h2>
            
            <div style="background: var(--light-bg-1); padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--primary-dark); text-align: center; font-size: 18px;">⚙️ 選擇你要挑戰的「的」</div>
                
                <div style="display:flex; gap:10px; margin-bottom:15px; justify-content:center;">
                    <button onclick="selectAllOptions(true)" style="padding: 6px 15px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor:pointer;">全選</button>
                    <button onclick="selectAllOptions(false)" style="padding: 6px 15px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor:pointer;">全不選</button>
                </div>
                
                <div id="optionsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 40vh; overflow-y: auto;">
                    </div>
            </div>

            <button onclick="startGameSession()" style="background: var(--primary-color); color: white; padding: 15px 40px; font-size: 1.2rem; border-radius: 50px; border:none; cursor:pointer; box-shadow: 0 5px 15px rgba(10, 147, 150, 0.4); font-weight:bold; transition: all 0.2s;">
                ▶ 開始挑戰 (Start)
            </button>
        </div>
        <div id="game-area" style="display: none;">
            <h1>英文「的」文法挑戰</h1>

            <div id="game-status-bar">
                <span>Q: <span id="q-current">1</span>/<span id="q-total">10</span></span>
                <div class="timer-container">
                    <div id="timer-bar"></div>
                    <div id="timer-text" class="timer-text">30.0</div>
                </div>
                <span>Score: <span id="score">0</span></span>
            </div>

            <div id="question-area">
                <div id="chinese-display">Loading...</div>
            </div>

            <div id="category-grid"></div>

            <div id="typing-area">
                <div class="typing-instruction">✅ 分類正確！請輸入對應的英文句子：</div>
                <input type="text" id="english-input" placeholder="請輸入英文" autocomplete="off">
                <button id="submit-sentence-btn">提交句子</button>
            </div>

            <div id="feedback-area"></div>

            <div id="controls">
                <button class="control-btn" id="back-btn" onclick="goBackToMenu()">返回選單</button>
                <button class="control-btn" id="next-btn" onclick="nextQuestion()">下一題 ➔</button>
            </div>
        </div>

        <div id="end-screen"></div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // ★ 核心 AI API 設置 (OpenRouter - Gemini 2.5 Flash)
        // ------------------------------------------------------------------
        const keyPart1 = "sk-or-v1-";
        const keyPart2 = "99843d0bae6f77f25b0bf50875a3cc23d9556e7e77d73b2a8828e9b690319381"; 
        const OPENROUTER_API_KEY = keyPart1 + keyPart2;

       async function checkAnswerWithAI(studentAnswer, questionChinese, ruleDesc, standardAnswer) {
            const prompt = `你是一個專業且寬容的英文老師，正在批改學生的翻譯題。
中文題目：「${questionChinese}」
必須使用的文法規則：「${ruleDesc}」
其中一個標準答案是：「${standardAnswer}」

學生提交的答案：「${studentAnswer}」

請判斷學生的答案是否可以接受。
判斷標準：
1. 允許合理的同義詞 (例如 guest/customer/client, picture/photo, colour/color 等)。
2. 允許美式/英式拼寫差異。
3. 允許不影響理解的極微小拼字錯誤。
4. 句意必須與中文題目一致 (注意情態動詞的語氣，例如可能 might/may vs 應該 should)。
5. 最重要的一點：必須符合規定的文法規則！如果文法結構錯了，即使意思對也是錯的。

請以 JSON 格式回覆，必須包含以下兩個欄位：
"isCorrect": true 或 false
"explanation": 如果錯了，請用繁體中文簡短解釋學生的句子錯在哪裡 (例如用字不當、文法錯誤、語氣不對)，以及為什麼標準答案才是對的。如果答對了，可以留空或給一句鼓勵說話。只輸出 JSON，不要其他廢話。`;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href, 
                        "X-Title": "English Grammar Game"
                    },
                    body: JSON.stringify({
                        "model": "google/gemini-2.5-flash", 
                        "messages": [ {"role": "user", "content": prompt} ]
                    })
                });

                if (!response.ok) throw new Error("API error");
                const data = await response.json();
                let reply = data.choices[0].message.content.trim();
                
                // 清理 AI 可能包含的 Markdown 標籤 (例如 ```json ... ```)
                if (reply.startsWith("```json")) {
                    reply = reply.replace(/^```json/, '').replace(/```$/, '').trim();
                } else if (reply.startsWith("```")) {
                    reply = reply.replace(/^```/, '').replace(/```$/, '').trim();
                }

                const result = JSON.parse(reply);
                return {
                    isCorrect: result.isCorrect === true || result.isCorrect === "true",
                    explanation: result.explanation || ""
                };
            } catch (error) {
                console.error("AI Check failed:", error);
                return { isCorrect: false, explanation: "AI 系統繁忙，請參考標準答案。" };
            }
        }


        // ------------------------------------------------------------------
        // 1. 分類定義與解釋對照表 
        // ------------------------------------------------------------------
        const categories = [
            { id: 1, name: "簡單形容詞 / 數字+量詞" },
            { id: 2, name: "有生命的 (人/動物/地方 's)" },
            { id: 3, name: "有...的 (with)" },
            { id: 4, name: "沒有...的 (without)" },
            { id: 5, name: "關於...的 (about)" },
            { id: 6, name: "主動動詞 / Modal Verb" },
            { id: 7, name: "被動動詞 (p.p.)" },
            { id: 8, name: "複合形容詞 (afraid of...等)" },
            { id: 9, name: "句子 + 的" },
            { id: 10, name: "死物的死物 (the...of...)" },
            { id: 11, name: "地方 + 的" },
            { id: 12, name: "時間 + 的" }
        ];

let selectedCategories = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]; // 預設全選 12 款

        function renderOptions() {
            const container = document.getElementById('optionsContainer');
            if(!container) return; // 避免找不到元素的報錯
            container.innerHTML = '';
            categories.forEach(cat => {
                const isChecked = selectedCategories.includes(cat.id) ? 'checked' : '';
                container.innerHTML += `
                    <label class="option-label">
                        <input type="checkbox" class="option-checkbox" value="${cat.id}" ${isChecked}>
                        ${cat.name}
                    </label>
                `;
            });
        }

        function selectAllOptions(selectAll) {
            const checkboxes = document.querySelectorAll('.option-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll);
        }

        function startGameSession() {
            // 在按開始遊戲時，即時讀取玩家勾選了哪些
            const checkboxes = document.querySelectorAll('.option-checkbox');
            selectedCategories = [];
            checkboxes.forEach(cb => {
                if (cb.checked) selectedCategories.push(parseInt(cb.value));
            });

            if (selectedCategories.length === 0) {
                alert("請至少選擇一種「的」！");
                return;
            }

            document.getElementById('startOverlay').style.display = 'none';
            document.getElementById('game-area').style.display = 'block';
            initGame(false);
        }

        // 當網頁載入時，立刻在畫面上畫出選項
        window.addEventListener('DOMContentLoaded', () => {
            renderOptions();
        });
        const ruleToCategory = {
            3: 1, 1: 2, 2: 2, 7: 3, 8: 4, 13: 5, 5: 6, 6: 6, 14: 7, 10: 8, 9: 9, 4: 10, 12: 11, 11: 12
        };

        const ruleExplanations = {
            1: "「的」前面是人稱擁有的物品，使用 's 形式。",
            2: "「的」前面是動物或地方擁有的事物，使用 's 形式。",
            3: "這屬於「數字+量詞」，數字和量詞之間需加連字號 (-)，且量詞不加 s。",
            4: "這屬於「死物的死物」，兩個無生命的名詞需前後調轉並用 of 連接 (the...of...)。",
            5: "後置修飾：包含主動動詞，使用 who/which/that + 動詞。",
            6: "後置修飾：包含情態動詞 (can/will/should 等)，使用 who/which/that + modal + 動詞。",
            7: "表示「有...的」，擁有某特徵或物品，使用介系詞 with。",
            8: "表示「沒有...的」，不具有某特徵或物品，使用介系詞 without。",
            9: "直接將「主語+動詞」的完整句子放在名詞後方修飾。",
            10: "這屬於「複合形容詞」，使用形容詞搭配介系詞 (如 fond of, full of 等) 放在名詞後方。",
            11: "將時間詞後置在名詞後方修飾 (如 in the past, tomorrow)。",
            12: "將地方副詞或介系詞片語後置在名詞後方修飾 (如 there, on the table)。",
            13: "表示內容關於某事物，使用 about。",
            14: "表示被動動作 (如被稱為、被製造)，直接將過去分詞 (p.p.) 放在名詞後方。"
        };

        // ------------------------------------------------------------------
        // 2. 題庫資料 (140題) 
        // ------------------------------------------------------------------
        const questionBank = [
            // Rule 1: 人稱 's
            { rule: 1, chinese: "我的朋友的書", correct_tokens: [ ["my", "friend's", "book"] ] },
            { rule: 1, chinese: "彼得的車", correct_tokens: [ ["Peter's", "car"] ] },
            { rule: 1, chinese: "那個老師的建議", correct_tokens: [ ["the", "teacher's", "advice"] ] },
            { rule: 1, chinese: "媽媽的禮物", correct_tokens: [ ["mom's", "gift"] ] },
            { rule: 1, chinese: "瑪莉的房間", correct_tokens: [ ["Mary's", "room"] ] },
            { rule: 1, chinese: "那個男孩的玩具", correct_tokens: [ ["that", "boy's", "toy"] ] },
            { rule: 1, chinese: "我們老闆的決定", correct_tokens: [ ["our", "boss's", "decision"] ] },
            { rule: 1, chinese: "約翰的電腦", correct_tokens: [ ["John's", "computer"] ] },
            { rule: 1, chinese: "這女人的手袋", correct_tokens: [ ["this", "woman's", "handbag"] ] },
            { rule: 1, chinese: "這些學生的筆", correct_tokens: [ ["these", "students'", "pens"] ] },

            // Rule 2: 動物/地方 's
            { rule: 2, chinese: "台灣的文化", correct_tokens: [ ["Taiwan's", "culture"] ] },
            { rule: 2, chinese: "那隻狗的尾巴", correct_tokens: [ ["the", "dog's", "tail"] ] },
            { rule: 2, chinese: "香港的經濟", correct_tokens: [ ["Hong", "Kong's", "economy"] ] },
            { rule: 2, chinese: "貓的眼睛", correct_tokens: [ ["the", "cat's", "eyes"] ] },
            { rule: 2, chinese: "世界的和平", correct_tokens: [ ["the", "world's", "peace"] ] },
            { rule: 2, chinese: "公司的利潤", correct_tokens: [ ["the", "company's", "profit"] ] },
            { rule: 2, chinese: "城市的發展", correct_tokens: [ ["the", "city's", "development"] ] },
            { rule: 2, chinese: "獅子的吼聲", correct_tokens: [ ["the", "lion's", "roar"] ] },
            { rule: 2, chinese: "我們的學校的規定", correct_tokens: [ ["our", "school's", "rules"] ] },
            { rule: 2, chinese: "日本的歷史", correct_tokens: [ ["Japan's", "history"] ] },

            // Rule 3: 數字+量詞+的
            { rule: 3, chinese: "一座五層高的建築物", correct_tokens: [ ["a", "five-storey", "building"], ["a", "5-storey", "building"] ] },
            { rule: 3, chinese: "一個十歲的男孩", correct_tokens: [ ["a", "ten-year-old", "boy"], ["a", "10-year-old", "boy"] ] },
            { rule: 3, chinese: "一張一百元的鈔票", correct_tokens: [ ["a", "one-hundred-dollar", "bill"], ["a", "100-dollar", "bill"] ] },
            { rule: 3, chinese: "一個兩小時的會議", correct_tokens: [ ["a", "two-hour", "meeting"], ["a", "2-hour", "meeting"] ] },
            { rule: 3, chinese: "一段三公里的路程", correct_tokens: [ ["a", "three-kilometer", "journey"], ["a", "3-kilometer", "journey"] ] },
            { rule: 3, chinese: "一個四星級的酒店", correct_tokens: [ ["a", "four-star", "hotel"], ["a", "4-star", "hotel"] ] },
            { rule: 3, chinese: "一份五頁的報告", correct_tokens: [ ["a", "five-page", "report"], ["a", "5-page", "report"] ] },
            { rule: 3, chinese: "一個六人的團隊", correct_tokens: [ ["a", "six-person", "team"], ["a", "6-person", "team"] ] },
            { rule: 3, chinese: "一段十分鐘的休息", correct_tokens: [ ["a", "ten-minute", "break"], ["a", "10-minute", "break"] ] },
            { rule: 3, chinese: "一個七天的假期", correct_tokens: [ ["a", "seven-day", "holiday"], ["a", "7-day", "holiday"] ] },

            // Rule 4: 無生命的 of
            { rule: 4, chinese: "這個袋子的價格", correct_tokens: [ ["the", "price", "of", "the", "bag"] ] },
            { rule: 4, chinese: "這本書的封面", correct_tokens: [ ["the", "cover", "of", "the", "book"] ] },
            { rule: 4, chinese: "這間房子的屋頂", correct_tokens: [ ["the", "roof", "of", "the", "house"] ] },
            { rule: 4, chinese: "這個電腦的屏幕", correct_tokens: [ ["the", "screen", "of", "the", "computer"] ] },
            { rule: 4, chinese: "香港的人口", correct_tokens: [ ["the", "population", "of", "Hong", "Kong"] ] },
            { rule: 4, chinese: "這首歌的名字", correct_tokens: [ ["the", "name", "of", "this", "song"] ] },
            { rule: 4, chinese: "這張桌子的顏色", correct_tokens: [ ["the", "color", "of", "this", "table"], ["the", "colour", "of", "this", "table"] ] },
            { rule: 4, chinese: "成功的關鍵", correct_tokens: [ ["the", "key", "to", "success"], ["the", "key", "of", "success"] ] },
            { rule: 4, chinese: "這個問題的原因", correct_tokens: [ ["the", "cause", "of", "the", "problem"] ] },
            { rule: 4, chinese: "這個故事的結尾", correct_tokens: [ ["the", "end", "of", "the", "story"] ] },

            // Rule 5: 主動動詞
            { rule: 5, chinese: "經常哭的那個男孩", correct_tokens: [ ["the", "boy", "who", "often", "cries"] ] },
            { rule: 5, chinese: "不喜歡我的那個老師", correct_tokens: [ ["the", "teacher", "who", "does", "not","like", "me"] ] },
            { rule: 5, chinese: "昨天沒有來的學生", correct_tokens: [ ["students", "who", "did", "not","come", "yesterday"], ["the", "students", "who", "did", "not","come", "yesterday"] ] },
            { rule: 5, chinese: "住在隔壁的那個女人", correct_tokens: [ ["the", "woman", "who", "lives", "next", "door"] ] },
            { rule: 5, chinese: "很多遊客參觀的那個博物館", correct_tokens: [ ["the", "museum", "which", "many", "tourists", "visit"], ["the", "museum", "that", "many", "tourists", "visit"] ] },
            { rule: 5, chinese: "正在睡覺的那隻貓", correct_tokens: [ ["the", "cat", "which", "is", "sleeping"], ["the", "cat", "that", "is", "sleeping"] ] },
            { rule: 5, chinese: "正在運行的那台機器", correct_tokens: [ ["the", "machine", "which", "is", "running"], ["the", "machine", "that", "is", "running"] ] },
            { rule: 5, chinese: "教英文的那位老師", correct_tokens: [ ["the", "teacher", "who", "teaches", "English"] ] },
            { rule: 5, chinese: "製造噪音的那些狗", correct_tokens: [ ["the", "dogs", "which", "make", "noise"], ["the", "dogs", "that", "make", "noise"] ] },
            { rule: 5, chinese: "喜歡音樂的那些人", correct_tokens: [ ["the", "people", "who", "like", "music"], ["people", "who", "like", "music"] ] },
            { rule: 5, chinese: "賣水果的那家店", correct_tokens: [ ["the", "shop", "which", "sells", "fruit"], ["the", "shop", "that", "sells", "fruit"] ] },
            { rule: 5, chinese: "開得很快的那輛車", correct_tokens: [ ["the", "car", "which", "drives", "very", "fast"], ["the", "car", "that", "drives", "very", "fast"] ] },

            // Rule 6: Modal verb
            { rule: 6, chinese: "一個唱得很好的女孩", correct_tokens: [ ["a", "girl", "who", "can", "sing", "well"] ] },
            { rule: 6, chinese: "一個應該被懲罰的學生", correct_tokens: [ ["a", "student", "who", "should", "be", "punished"] ] },
            { rule: 6, chinese: "一個將會成功的計劃", correct_tokens: [ ["a", "plan", "that", "will", "succeed"], ["a", "plan", "which", "will", "succeed"] ] },
            { rule: 6, chinese: "一個可能下雨的日子", correct_tokens: [ ["a", "day", "which", "may", "rain"], ["a", "day", "that", "may", "rain"] ] },
            { rule: 6, chinese: "一個必須努力工作的人", correct_tokens: [ ["a", "person", "who", "must", "work", "hard"] ] },
            { rule: 6, chinese: "一個可以幫助你的人", correct_tokens: [ ["someone", "who", "can", "help", "you"], ["a", "person", "who", "can", "help", "you"] ] },
            { rule: 6, chinese: "一個將會改變世界的想法", correct_tokens: [ ["an", "idea", "that", "will", "change", "the", "world"], ["an", "idea", "which", "will", "change", "the", "world"] ] },
            { rule: 6, chinese: "一個應該更小心的司機", correct_tokens: [ ["a", "driver", "who", "should", "be", "more", "careful"] ] },
            { rule: 6, chinese: "一個可能會遲到的客人", correct_tokens: [ ["a", "guest", "who", "might", "be", "late"] ] },
            { rule: 6, chinese: "一個必須遵守規則的球員", correct_tokens: [ ["a", "player", "who", "must", "follow", "the", "rules"] ] },

            // Rule 7: With
            { rule: 7, chinese: "一個有長頭髮的女孩", correct_tokens: [ ["a", "girl", "with", "long", "hair"] ] },
            { rule: 7, chinese: "一間有大花園的屋", correct_tokens: [ ["a", "house", "with", "a", "big", "garden"] ] },
            { rule: 7, chinese: "一個有藍眼睛的嬰兒", correct_tokens: [ ["a", "baby", "with", "blue", "eyes"] ] },
            { rule: 7, chinese: "一本有許多圖片的書", correct_tokens: [ ["a", "book", "with", "many", "pictures"] ] },
            { rule: 7, chinese: "一個有豐富經驗的人", correct_tokens: [ ["a", "person", "with", "rich", "experience"] ] },
            { rule: 7, chinese: "一張有花紋的桌子", correct_tokens: [ ["a", "table", "with", "floral", "patterns"] ] },
            { rule: 7, chinese: "一件有紅色條紋的襯衫", correct_tokens: [ ["a", "shirt", "with", "red", "stripes"] ] },
            { rule: 7, chinese: "一個有大鼻子的人", correct_tokens: [ ["a", "person", "with", "a", "big", "nose"] ] },
            { rule: 7, chinese: "一部有高解像度屏幕的手機", correct_tokens: [ ["a", "phone", "with", "a", "high", "resolution", "screen"] ] },
            { rule: 7, chinese: "一個有幽默感的朋友", correct_tokens: [ ["a", "friend", "with", "a", "sense", "of", "humor"], ["a", "friend", "with", "a", "sense", "of", "humour"] ] },

            // Rule 8: Without
            { rule: 8, chinese: "一個沒有勇氣的人", correct_tokens: [ ["a", "man", "without", "courage"], ["a", "person", "without", "courage"] ] },
            { rule: 8, chinese: "一杯沒有糖的咖啡", correct_tokens: [ ["a", "cup", "of", "coffee", "without", "sugar"] ] },
            { rule: 8, chinese: "一個沒有窗戶的房間", correct_tokens: [ ["a", "room", "without", "windows"] ] },
            { rule: 8, chinese: "一個沒有名字的城市", correct_tokens: [ ["a", "city", "without", "a", "name"] ] },
            { rule: 8, chinese: "一段沒有街燈的路", correct_tokens: [ ["a", "road", "without", "streetlights"] ] },
            { rule: 8, chinese: "一個沒有手機的學生", correct_tokens: [ ["a", "student", "without", "a", "mobile", "phone"], ["a", "student", "without", "a", "phone"] ] },
            { rule: 8, chinese: "一隻沒有尾巴的貓", correct_tokens: [ ["a", "cat", "without", "a", "tail"] ] },
            { rule: 8, chinese: "一個沒有理由的決定", correct_tokens: [ ["a", "decision", "without", "a", "reason"] ] },
            { rule: 8, chinese: "一個沒有經驗的工人", correct_tokens: [ ["a", "worker", "without", "experience"] ] },
            { rule: 8, chinese: "一個沒有朋友的小孩", correct_tokens: [ ["a", "child", "without", "friends"] ] },

            // Rule 9: 句子+的
            { rule: 9, chinese: "每個人都喜歡的那個歌手", correct_tokens: [ ["the", "singer", "everyone", "likes"], ["the", "singer", "who", "everyone", "likes"] ] },
            { rule: 9, chinese: "我昨天買的那本書", correct_tokens: [ ["the", "book", "I", "bought", "yesterday"], ["the", "book", "which", "I", "bought", "yesterday"] ] },
            { rule: 9, chinese: "我們正在談論的那部電影", correct_tokens: [ ["the", "movie", "we", "are", "talking", "about"], ["the", "movie", "which", "we", "are", "talking", "about"] ] },
            { rule: 9, chinese: "你給我的那個禮物", correct_tokens: [ ["the", "gift", "you", "gave", "me"], ["the", "gift", "which", "you", "gave", "me"] ] },
            { rule: 9, chinese: "我想去的地方", correct_tokens: [ ["the", "place", "I", "want", "to", "go"], ["the", "place", "where", "I", "want", "to", "go"] ] },
            { rule: 9, chinese: "他告訴我的那個故事", correct_tokens: [ ["the", "story", "he", "told", "me"], ["the", "story", "which", "he", "told", "me"] ] },
            { rule: 9, chinese: "你做的食物", correct_tokens: [ ["the", "food", "you", "cooked"], ["the", "food", "which", "you", "cooked"] ] },
            { rule: 9, chinese: "我認識的那個人", correct_tokens: [ ["the", "person", "I", "know"], ["the", "person", "who", "I", "know"] ] },
            { rule: 9, chinese: "我們住的房子", correct_tokens: [ ["the", "house", "we", "live", "in"], ["the", "house", "which", "we", "live", "in"] ] },
            { rule: 9, chinese: "你正在尋找的答案", correct_tokens: [ ["the", "answer", "you", "are", "looking", "for"], ["the", "answer", "which", "you", "are", "looking", "for"] ] },

            // Rule 10: 複合形容詞+的
            { rule: 10, chinese: "一個熱愛唱歌的女孩", correct_tokens: [ ["a", "girl", "fond", "of", "singing"], ["a", "girl", "who", "is", "fond", "of", "singing"] ] },
            { rule: 10, chinese: "一本充滿圖片的書", correct_tokens: [ ["a", "book", "full", "of", "pictures"], ["a", "book", "which", "is", "full", "of", "pictures"] ] },
            { rule: 10, chinese: "一個對電腦熟悉的男孩", correct_tokens: [ ["a", "boy", "familiar", "with", "computers"], ["a", "boy", "who", "is", "familiar", "with", "computers"] ] },
            { rule: 10, chinese: "一個對健康有害的習慣", correct_tokens: [ ["a", "habit", "harmful", "to", "health"], ["a", "habit", "which", "is", "harmful", "to", "health"] ] },
            { rule: 10, chinese: "一個對每個人都友善的人", correct_tokens: [ ["a", "person", "friendly", "to", "everyone"], ["a", "person", "who", "is", "friendly", "to", "everyone"] ] },
            { rule: 10, chinese: "一個可以使用的房間", correct_tokens: [ ["a", "room", "available", "for", "use"], ["a", "room", "which", "is", "available", "for", "use"] ] },
            { rule: 10, chinese: "一個對這個提議感興趣的人", correct_tokens: [ ["a", "person", "interested", "in", "the", "proposal"], ["a", "person", "who", "is", "interested", "in", "the", "proposal"] ] },
            { rule: 10, chinese: "一個能夠做這項工作的人", correct_tokens: [ ["a", "person", "capable", "of", "doing", "the", "job"], ["a", "person", "who", "is", "capable", "of", "doing", "the", "job"] ] },
            { rule: 10, chinese: "一個對這個項目負責的經理", correct_tokens: [ ["a", "manager", "responsible", "for", "the", "project"], ["a", "manager", "who", "is", "responsible", "for", "the", "project"] ] },
            { rule: 10, chinese: "一個類似於我的想法", correct_tokens: [ ["an", "idea", "similar", "to", "mine"], ["an", "idea", "which", "is", "similar", "to", "mine"] ] },

            // Rule 11: 時間詞
            { rule: 11, chinese: "過去的人們", correct_tokens: [ ["people", "in", "the", "past"] ] },
            { rule: 11, chinese: "明天的那個會議", correct_tokens: [ ["the", "meeting", "tomorrow"] ] },
            { rule: 11, chinese: "今天的那份報紙", correct_tokens: [ ["the", "newspaper", "today"] ] },
            { rule: 11, chinese: "昨天的派對", correct_tokens: [ ["the", "party", "yesterday"] ] },
            { rule: 11, chinese: "將來的世界", correct_tokens: [ ["the", "world", "in", "the", "future"] ] },
            { rule: 11, chinese: "今晚的晚餐", correct_tokens: [ ["the", "dinner", "tonight"] ] },
            { rule: 11, chinese: "現在的學生", correct_tokens: [ ["students", "nowadays"], ["students", "now"] ] },
            { rule: 11, chinese: "早上的課", correct_tokens: [ ["the", "class", "in", "the", "morning"] ] },
            { rule: 11, chinese: "2020年的奧運會", correct_tokens: [ ["the", "Olympics", "in", "2020"] ] },
            { rule: 11, chinese: "週日的野餐", correct_tokens: [ ["the", "picnic", "on", "Sunday"] ] },

            // Rule 12: 地點詞
            { rule: 12, chinese: "那裡的人", correct_tokens: [ ["the", "people", "there"], ["people", "there"] ] },
            { rule: 12, chinese: "這裡的食物", correct_tokens: [ ["the", "food", "here"], ["food", "here"] ] },
            { rule: 12, chinese: "海外的學生", correct_tokens: [ ["students", "overseas"] ] },
            { rule: 12, chinese: "國外的朋友", correct_tokens: [ ["friends", "abroad"] ] },
            { rule: 12, chinese: "樓上的那個房間", correct_tokens: [ ["the", "room", "upstairs"] ] },
            { rule: 12, chinese: "樓下的那個鄰居", correct_tokens: [ ["the", "neighbor", "downstairs"], ["the", "neighbour", "downstairs"] ] },
            { rule: 12, chinese: "附近的那個公園", correct_tokens: [ ["the", "park", "nearby"] ] },
            { rule: 12, chinese: "在桌上的那本書", correct_tokens: [ ["the", "book", "on", "the", "table"], ["the", "book", "on", "the", "desk"] ] },
            { rule: 12, chinese: "在香港的商店", correct_tokens: [ ["shops", "in", "Hong", "Kong"] ] },
            { rule: 12, chinese: "在家裡的生活", correct_tokens: [ ["life", "at", "home"] ] },

            // Rule 13: About
            { rule: 13, chinese: "一本有關中國的書", correct_tokens: [ ["a", "book", "about", "China"] ] },
            { rule: 13, chinese: "一個關於未來的討論", correct_tokens: [ ["a", "discussion", "about", "the", "future"] ] },
            { rule: 13, chinese: "一個關於愛的故事", correct_tokens: [ ["a", "story", "about", "love"] ] },
            { rule: 13, chinese: "一部關於戰爭的電影", correct_tokens: [ ["a", "movie", "about", "wars"], ["a", "movie", "about", "war"], ["a", "film", "about", "war"] ] },
            { rule: 13, chinese: "一則關於天氣的新聞", correct_tokens: [ ["news", "about", "the", "weather"] ] },
            { rule: 13, chinese: "一個關於健康的節目", correct_tokens: [ ["a", "program", "about", "health"], ["a", "programme", "about", "health"] ] },
            { rule: 13, chinese: "一場關於政治的辯論", correct_tokens: [ ["a", "debate", "about", "politics"] ] },
            { rule: 13, chinese: "一篇關於歷史的文章", correct_tokens: [ ["an", "article", "about", "history"] ] },
            { rule: 13, chinese: "一個關於科學的問題", correct_tokens: [ ["a", "question", "about", "science"] ] },
            { rule: 13, chinese: "一個關於安全的擔憂", correct_tokens: [ ["a", "worry", "about", "safety"], ["a", "concern", "about", "safety"] ] },

            // Rule 14: 被動動詞 (PP)
            { rule: 14, chinese: "一個被稱為宙斯的男人", correct_tokens: [ ["a", "man", "called", "Zeus"] ] },
            { rule: 14, chinese: "一份未被老闆批准的提議", correct_tokens: [ ["a", "proposal", "not", "approved", "by", "the", "boss"] ] },
            { rule: 14, chinese: "一本用英語寫的書", correct_tokens: [ ["a", "book", "written", "in", "English"] ] },
            { rule: 14, chinese: "一個被邀請參加派對的客人", correct_tokens: [ ["a", "guest", "invited", "to", "the", "party"] ] },
            { rule: 14, chinese: "一輛日本製造的車", correct_tokens: [ ["a", "car", "made", "in", "Japan"] ] },
            { rule: 14, chinese: "一個被警察抓住的小偷", correct_tokens: [ ["a", "thief", "caught", "by", "the", "police"] ] },
            { rule: 14, chinese: "一封寄給瑪莉的信", correct_tokens: [ ["a", "letter", "sent", "to", "Mary"] ] },
            { rule: 14, chinese: "一個被很多人愛戴的領袖", correct_tokens: [ ["a", "leader", "loved", "by", "many", "people"] ] },
            { rule: 14, chinese: "一間被火燒毀的房子", correct_tokens: [ ["a", "house", "destroyed", "by", "fire"] ] },
            { rule: 14, chinese: "一個未解決的問題", correct_tokens: [ ["a", "problem", "not", "solved"], ["an", "unsolved", "problem"] ] }
        ];

        // ------------------------------------------------------------------
        // 3. 遊戲狀態與 DOM
        // ------------------------------------------------------------------
        let currentQIndex = 0;
        let score = 0;
        let currentQ = null;
        let shuffledQuestions = [];
        let gameHistory = []; 
        let currentPhase = 1; // 1 = 選擇分類, 2 = 寫句子
        
        // Timer
        let timeLeft = 30;
        let timerInterval = null;
        let defaultPhase1Time = 30;
        let defaultPhase2Time = 40;
        
        const dom = {
            gameArea: document.getElementById('game-area'),
            endScreen: document.getElementById('end-screen'),
            qCurrent: document.getElementById('q-current'),
            qTotal: document.getElementById('q-total'),
            timerBar: document.getElementById('timer-bar'),
            timerText: document.getElementById('timer-text'),
            score: document.getElementById('score'),
            chineseDisplay: document.getElementById('chinese-display'),
            categoryGrid: document.getElementById('category-grid'),
            typingArea: document.getElementById('typing-area'),
            englishInput: document.getElementById('english-input'),
            submitSentenceBtn: document.getElementById('submit-sentence-btn'),
            feedbackArea: document.getElementById('feedback-area'),
            nextBtn: document.getElementById('next-btn'),
            backBtn: document.getElementById('back-btn')
        };

        // 音效系統
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }
        function playBeep(freq = 800, dur = 0.1) { playTone(freq, 'sine', dur); }

        const sfx = {
            click: () => playTone(600, 'triangle', 0.05),
            correct: () => { playTone(660, 'square', 0.1); setTimeout(() => playTone(880, 'square', 0.2), 100); },
            wrong: () => playTone(200, 'sawtooth', 0.3),
            win: () => { playTone(440, 'sine', 0.1); setTimeout(() => playTone(554, 'sine', 0.1), 100); setTimeout(() => playTone(659, 'sine', 0.2), 200); },
            countdown: () => playBeep(880, 0.1),
            timeup: () => playTone(150, 'sawtooth', 0.5)
        };

        // ------------------------------------------------------------------
        // 4. 遊戲邏輯
        // ------------------------------------------------------------------
        
function initGame(isRetry = false) {
            currentQIndex = 0;
            score = 0;
            gameHistory = [];
            
            dom.endScreen.style.display = 'none';
            dom.gameArea.style.display = 'block';

            if (!isRetry) {
                // 找出所有被勾選的 Category 對應的 Rule ID
                let allowedRules = Object.keys(ruleToCategory)
                                         .filter(rule => selectedCategories.includes(ruleToCategory[rule]))
                                         .map(Number);
                
                // 過濾題庫 (只保留被選中的規則題目)
                let filteredQuestions = questionBank.filter(q => allowedRules.includes(q.rule));
                
                // 如果題庫不夠 10 題，就全拿；否則隨機抽 10 題
                const maxQ = Math.min(10, filteredQuestions.length);
                shuffledQuestions = filteredQuestions.sort(() => Math.random() - 0.5).slice(0, maxQ);
            } 

            if (shuffledQuestions.length === 0) {
                alert("這幾類剛好沒有對應的題目，請重新選擇！");
                goBackToMenu();
                return;
            }

            dom.qTotal.innerText = shuffledQuestions.length;
            renderCategories();
            loadQuestion();
        }

        function renderCategories() {
            dom.categoryGrid.innerHTML = '';
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerText = cat.name;
                btn.onclick = () => handleCategoryClick(cat.id, cat.name);
                dom.categoryGrid.appendChild(btn);
            });
        }

        function loadQuestion() {
            if (currentQIndex >= shuffledQuestions.length) {
                endGame();
                return;
            }

            currentPhase = 1;
            currentQ = shuffledQuestions[currentQIndex];
            
            dom.qCurrent.innerText = currentQIndex + 1;
            dom.score.innerText = score;
            dom.chineseDisplay.innerText = currentQ.chinese;
            
            // 重置 UI 狀態
            dom.categoryGrid.style.display = 'grid';
            Array.from(dom.categoryGrid.children).forEach(btn => btn.disabled = false);
            dom.typingArea.style.display = 'none';
            dom.englishInput.value = '';
            dom.englishInput.disabled = false;
            
            dom.submitSentenceBtn.style.display = 'block';
            dom.submitSentenceBtn.disabled = false;
            dom.submitSentenceBtn.innerText = "提交句子";
            
            dom.feedbackArea.innerHTML = '';
            dom.nextBtn.style.display = 'none';
            dom.backBtn.style.display = 'inline-block';

            startTimer(defaultPhase1Time);
        }

        function startTimer(seconds) {
            clearInterval(timerInterval);
            timeLeft = seconds; 
            updateTimerUI();
            
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                
                if (timeLeft <= 3.0 && timeLeft > 0) {
                    if (Math.abs(timeLeft % 1) < 0.1) sfx.countdown();
                }

                if (timeLeft <= 0) {
                    timeLeft = 0;
                    handleTimeout();
                }
                updateTimerUI();
            }, 100);
        }

        function stopTimer() { clearInterval(timerInterval); }

        function updateTimerUI() {
            dom.timerText.innerText = Math.abs(timeLeft).toFixed(1);
            let totalTime = currentPhase === 1 ? defaultPhase1Time : defaultPhase2Time;
            let pct = (timeLeft / totalTime) * 100;
            dom.timerBar.style.width = `${pct}%`;
            
            if (timeLeft <= 5) dom.timerBar.style.backgroundColor = 'var(--danger-color)';
            else dom.timerBar.style.backgroundColor = 'var(--primary-color)';
        }

        function handleTimeout() {
            stopTimer();
            sfx.timeup();
            
            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let correctAnsStr = currentQ.correct_tokens[0].join(' ');
            
            if (currentPhase === 1) {
                Array.from(dom.categoryGrid.children).forEach(btn => btn.disabled = true);
                showFeedback(false, `⏰ 時間到！<br>正確分類: <strong>${correctCatName}</strong><br>正確句子: <strong>${correctAnsStr}</strong>`);
                recordHistory(false, "Timeout", false, "Timeout", false);
                showNextBtn();
            } else {
                dom.submitSentenceBtn.style.display = 'none';
                dom.englishInput.disabled = true;
                showFeedback(false, `⏰ 時間到！<br>正確句子: <strong>${correctAnsStr}</strong>`);
                recordHistory(true, correctCatName, false, "Timeout", false);
                showNextBtn();
            }
        }

        // --- 階段一：判斷分類 ---
        function handleCategoryClick(selectedId, selectedName) {
            sfx.click();
            stopTimer();
            Array.from(dom.categoryGrid.children).forEach(btn => btn.disabled = true);

            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let correctAnsStr = currentQ.correct_tokens[0].join(' ');
            let explanation = ruleExplanations[currentQ.rule];

            if (selectedId === correctCatId) {
                // 答對了
                score += 5;
                dom.score.innerText = score;
                sfx.correct();
                
                dom.categoryGrid.style.display = 'none';
                dom.typingArea.style.display = 'flex';
                dom.englishInput.focus();
                dom.backBtn.style.display = 'none';
                
                currentPhase = 2;
                startTimer(defaultPhase2Time); 
            } else {
                // 答錯了
                sfx.wrong();
                let msg = `❌ 選擇錯誤！<br>
                           正確分類是：<strong>${correctCatName}</strong><br>
                           <div class="explanation-hint">💡 解釋：${explanation}</div><br>
                           正確句子應為：<strong>${correctAnsStr}</strong>`;
                showFeedback(false, msg);
                recordHistory(false, selectedName, false, "(未進入)", false);
                showNextBtn();
            }
        }

        function formatTextForComparison(text) {
            return text.toLowerCase().trim().replace(/\s+/g, ' ').replace(/[.,!?;]*$/, '');
        }

        // --- 階段二：檢查輸入的句子 (整合 AI) ---
       async function checkSentence() {
            if (dom.submitSentenceBtn.disabled) return;
            
            sfx.click();
            stopTimer();

            const userTyping = dom.englishInput.value;
            const formattedUserInput = formatTextForComparison(userTyping);
            
            const correctAnswers = currentQ.correct_tokens.map(arr => arr.join(' '));
            const formattedCorrectAnswers = correctAnswers.map(formatTextForComparison);
            
            let isMatch = formattedCorrectAnswers.includes(formattedUserInput);
            let usedAI = false;
            let aiExplanation = ""; // 儲存 AI 解釋
            
            dom.submitSentenceBtn.disabled = true;
            dom.englishInput.disabled = true;

            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let ruleDesc = ruleExplanations[currentQ.rule];

            // 交給 AI 判斷
            if (!isMatch && formattedUserInput !== "") {
                usedAI = true;
                dom.submitSentenceBtn.innerText = "🤖 AI 判斷中...";
                const aiResult = await checkAnswerWithAI(userTyping, currentQ.chinese, ruleDesc, correctAnswers[0]);
                isMatch = aiResult.isCorrect;
                aiExplanation = aiResult.explanation;
            }
            
            dom.submitSentenceBtn.style.display = 'none';

            if (isMatch) {
                score += 5; 
                dom.score.innerText = score;
                
                let msg = usedAI ? "🎉 完美！AI 認可了你的同義詞/寫法！" : "🎉 完美！分類與句子完全正確！";
                let badge = usedAI ? `<span class="ai-badge">AI 判定</span>` : "";
                
                showFeedback(true, msg + badge);
                sfx.correct();
                recordHistory(true, correctCatName, true, userTyping, usedAI, aiExplanation);
            } else {
                let badge = usedAI ? `<span class="ai-badge">AI 判定</span>` : "";
                let explanationHtml = aiExplanation ? `<br><div style="color:#d35400; font-size:15px; margin-top:8px; text-align:left; background:#fff3cd; padding:8px; border-radius:6px; border:1px solid #ffeeba;">🤖 <strong>AI 點評：</strong>${aiExplanation}</div>` : "";
                
                showFeedback(false, `❌ 句子有誤！${badge}<br>標準寫法: <strong>${correctAnswers[0]}</strong>${explanationHtml}`);
                sfx.wrong();
                recordHistory(true, correctCatName, false, userTyping, usedAI, aiExplanation);
            }
            
            showNextBtn();
        }

        // 紀錄錯題與歷史
      function recordHistory(isCatCorrect, userCatName, isSentenceCorrect, userSentence, usedAI, aiExplanation = "") {
            let correctCatId = ruleToCategory[currentQ.rule];
            let correctCatName = categories.find(c => c.id === correctCatId).name;
            let correctSentence = currentQ.correct_tokens[0].join(' ');
            let isCompletelyCorrect = isCatCorrect && isSentenceCorrect;

            gameHistory.push({
                originalObj: currentQ, 
                questionText: currentQ.chinese,
                isCorrect: isCompletelyCorrect,
                isCatCorrect: isCatCorrect,
                correctCatName: correctCatName,
                userCatName: userCatName,
                isSentenceCorrect: isSentenceCorrect,
                correctSentence: correctSentence,
                userSentence: userSentence,
                usedAI: usedAI,
                aiExplanation: aiExplanation,
                explanation: ruleExplanations[currentQ.rule]
            });
        }
        function showFeedback(isSuccess, msg) {
            let colorClass = isSuccess ? 'text-correct' : 'text-wrong';
            dom.feedbackArea.innerHTML = `<div class="feedback-text ${colorClass}">${msg}</div>`;
        }

        function showNextBtn() {
            dom.nextBtn.style.display = 'block';
            dom.backBtn.style.display = 'none';
        }

        function nextQuestion() {
            sfx.click();
            currentQIndex++;
            loadQuestion();
        }

        function retryWrongQuestions() {
            const wrongQuestions = gameHistory.filter(h => !h.isCorrect).map(h => h.originalObj);
            if (wrongQuestions.length === 0) {
                alert("沒有錯題可以重做！");
                return;
            }
            shuffledQuestions = wrongQuestions;
            initGame(true);
        }

        function endGame() {
            stopTimer();
            dom.gameArea.style.display = 'none';
            dom.endScreen.style.display = 'block';
            sfx.win();

            const totalQ = shuffledQuestions.length;
            const percentage = Math.round((score / (totalQ * 10)) * 100); 

            const wrongAnswers = gameHistory.filter(h => !h.isCorrect);
            let analysisHTML = '';
            
            if (wrongAnswers.length > 0) {
                analysisHTML = `
                    <div class="error-analysis">
                        <h3 style="color:var(--danger-color)">錯誤複習 (${wrongAnswers.length} 題):</h3>
                        ${wrongAnswers.map(item => `
                            <div class="error-item">
                                <div style="margin-bottom:8px; font-weight:bold; color:#333;">題目: ${item.questionText}</div>
                                ${!item.isCatCorrect 
                                    ? `<div style="color:var(--danger-color)">❌ <strong>分類錯誤:</strong> 你選了 ${item.userCatName} (正確為 ${item.correctCatName})</div>`
                                    : `<div style="color:var(--success-color)">✅ <strong>分類正確:</strong> ${item.correctCatName}</div>`
                                }
                                ${!item.isSentenceCorrect && item.isCatCorrect
                                    ? `<div style="color:var(--danger-color)">❌ <strong>句子錯誤:</strong> ${item.userSentence} ${item.usedAI ? '<span class="ai-badge">AI 判定</span>' : ''}</div><div style="color:var(--primary-dark)"><strong>標準答案:</strong> ${item.correctSentence}</div>` + (item.aiExplanation ? `<div style="color:#d35400; margin-top:6px; font-size: 0.9em; background:#fff3cd; padding:6px; border-radius:4px;">🤖 <strong>AI 點評:</strong> ${item.aiExplanation}</div>` : "")
                                    : (!item.isCatCorrect ? `<div style="color:var(--primary-dark)"><strong>正確句子:</strong> ${item.correctSentence}</div>` : "")
                                }
                                <div style="font-size:0.9em; color:#666; margin-top:5px; padding-top:5px; border-top:1px dashed #ccc;">💡 <strong>相關規則：</strong>${item.explanation}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                analysisHTML = `<h3 style="color:var(--secondary-dark); margin-top:30px;">完美！全對！🎉</h3>`;
            }

            const retryBtnStyle = wrongAnswers.length > 0 ? "display:inline-block;" : "display:none;";

            dom.endScreen.innerHTML = `
                <div class="end-game-container">
                    <h1>Challenge Complete!</h1>
                    <div class="final-score">總得分: ${score} / ${totalQ * 10} (${percentage}%)</div>
                    ${analysisHTML}
                    <div class="result-controls">
                        <button class="result-btn btn-menu" onclick="goBackToMenu()">返回選單</button>
                        <button class="result-btn btn-retry-wrong" style="${retryBtnStyle}" onclick="retryWrongQuestions()">重做錯題</button>
                        <button class="result-btn btn-restart" onclick="initGame()">再來一次</button>
                    </div>
                </div>
            `;
        }

        dom.submitSentenceBtn.addEventListener('click', checkSentence);
        dom.englishInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && currentPhase === 2 && !dom.englishInput.disabled && !dom.submitSentenceBtn.disabled) {
                if (dom.englishInput.value.trim() === '') {
                    alert("請輸入英文句子！");
                    return;
                }
                checkSentence();
            }
        });
        
function goBackToMenu() {
            // 現在改為退回主選單，而不是離開頁面
            stopTimer();
            dom.gameArea.style.display = 'none';
            dom.endScreen.style.display = 'none';
            document.getElementById('startOverlay').style.display = 'block';
            renderOptions(); // 返回時重新顯示一下選項
        }

    </script>
</body>
</html>



