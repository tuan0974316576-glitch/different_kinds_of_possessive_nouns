<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡ã€Œçš„ã€æ–‡æ³•è¨“ç·´</title>
    <style>
        :root {
            --base-bg: #F1F3F3;       
            --primary-color: #0a9396;   
            --primary-dark: #005f73;    
            --secondary-color: #40916c; 
            --secondary-dark: #2d6a4f;  
            --light-bg-1: #e6eaea;      
            --light-bg-2: #e6f1f0;      
            --text-color: #212529;      
            --border-color: #ced4da;     
            --danger-color: #dc3545;     
            --danger-dark: #a42631;    
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--base-bg); 
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            border-radius: 6px; 
            border: 2px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            padding: 24px 32px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: var(--primary-dark); 
            margin-top: 0;
            margin-bottom: 20px;
        }

        #progress-tracker {
            text-align: right;
            font-size: 16px;
            font-weight: bold;
            color: #555;
            margin-bottom: 20px; 
            display: flex;
            justify-content: space-between; 
            align-items: center;
        }
        .score-display {
            color: var(--secondary-dark); 
            flex-basis: 33%; 
            text-align: left;
        }
        
        .timer-container {
            flex-basis: 33%; 
            text-align: center;
            position: relative; 
            height: 35px; 
            border-radius: 4px;
            background-color: var(--base-bg); 
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
        }

        #timer-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%;
            background-color: var(--primary-color); 
            transition: width 0.1s linear; 
            z-index: 1;
        }

        .timer-display {
            font-size: 20px; 
            font-weight: bold;
            font-family: 'Consolas', 'Courier New', monospace;
            color: white; 
            position: relative;
            z-index: 2; 
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.4);
        }
        
        .timer-warning #timer-bar { background-color: var(--danger-color); }
        .timer-warning .timer-display { animation: pulse 0.5s infinite alternate; }

        .question-number {
            color: var(--primary-dark);
            flex-basis: 33%; 
            text-align: right;
        }

        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }

        #chinese-prompt {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 24px;
            padding: 16px;
            background-color: var(--light-bg-1); 
            border-radius: 4px;
            border-left: 5px solid var(--primary-color);
            text-align: center;
        }

        .step-label {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-top: 16px;
            margin-bottom: 12px;
            border-bottom: 2px solid var(--light-bg-1);
            padding-bottom: 4px;
        }

        /* 12å®®æ ¼åˆ†é¡æŒ‰éˆ•å€ */
        #category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 24px;
        }

        .category-btn {
            padding: 12px 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            background-color: white;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .category-btn:hover {
            border-color: var(--primary-color);
            background-color: var(--light-bg-2);
        }

        .category-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* æ–‡å­—è¼¸å…¥å€ */
        #english-input {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.2s;
            margin-bottom: 10px;
        }
        
        #english-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(10, 147, 150, 0.2);
        }

        #controls {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin-top: 24px;
            position: relative; 
            height: 48px; 
        }

        #menu-btn, #check-btn, #restart-btn {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px; 
            border: 2px solid;
            transition: all 0.2s;
        }

        #menu-btn {
            color: var(--primary-color); 
            border-color: var(--primary-color); 
            background-color: white; 
        }
        #menu-btn:hover { background-color: var(--primary-color); color: white; }
        
        #check-btn {
            background-color: var(--primary-color); 
            color: white;
            border-color: var(--primary-dark);
            position: absolute; 
            right: 0; 
        }
        #check-btn:hover { background-color: var(--primary-dark); }
        
        #restart-btn {
            background-color: var(--danger-color);
            color: white;
            border-color: var(--danger-dark);
            display: none; 
            position: absolute; 
            right: 0; 
        }
        #restart-btn:hover { background-color: var(--danger-dark); }

        #feedback {
            margin-top: 20px;
            font-size: 16px;
            text-align: center;
            min-height: 20px; 
            padding: 10px;
            border-radius: 6px;
        }
        .feedback-correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .feedback-incorrect { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .feedback-partial { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        
        #error-history {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #f8d7da;
            background-color: #fff0f3;
            border-radius: 4px;
        }
        .error-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #ccc; }
        .error-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .error-item strong { color: var(--text-color); font-size: 16px; display: block; margin-bottom: 8px;}
        .error-detail { font-size: 15px; margin: 4px 0;}
        .wrong-text { color: var(--danger-color); font-weight: bold; }
        .correct-text { color: var(--secondary-dark); font-weight: bold; }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>è‹±æ–‡ã€Œçš„ã€æ–‡æ³•è¨“ç·´</h1>

        <div id="progress-tracker">
            <span class="score-display"></span>
            <span class="timer-container">
                <div id="timer-bar"></div>
                <span class="timer-display"></span>
            </span>
            <span class="question-number"></span>
        </div>

        <div id="chinese-prompt">ä¸­æ–‡é¡Œç›®æœƒé¡¯ç¤ºåœ¨é€™è£¡</div>

        <div class="step-label">ç¬¬ä¸€éƒ¨åˆ†ï¼šé¸æ“‡ã€Œçš„ã€çš„é¡å‹</div>
        <div id="category-grid"></div>

        <div class="step-label">ç¬¬äºŒéƒ¨åˆ†ï¼šè¼¸å…¥è‹±æ–‡å¥å­</div>
        <input type="text" id="english-input" autocomplete="off" placeholder="ä¾‹å¦‚ï¼ša five-storey building">

        <div id="feedback"></div>
        
        <div id="controls">
            <button id="menu-btn">è¿”å›é¸å–®</button>
            <button id="check-btn">æª¢æŸ¥ç­”æ¡ˆ</button>
            <button id="restart-btn">å†ä¾†ä¸€æ¬¡</button>
        </div>
        
        <div id="error-history" style="display: none;"></div>
    </div>

    <script>
        // --- éŸ³æ•ˆç³»çµ± ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(frequency, type, duration, volume = 0.1) {
            if (!audioContext) return;
            if (audioContext.state === 'suspended') audioContext.resume();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        function audioClickPlay() { playTone(600, 'triangle', 0.1); }
        function audioCorrectPlay() { 
            playTone(660, 'square', 0.08, 0.2); 
            setTimeout(() => playTone(880, 'square', 0.1, 0.25), 90); 
            setTimeout(() => playTone(1320, 'sine', 0.15, 0.3), 200); 
        }
        function audioIncorrectPlay() { playTone(200, 'sawtooth', 0.2); }
        function audioCountdownPlay() { playTone(800, 'square', 0.05, 0.15); }

        // --- 12 ç¨®ã€Œçš„ã€åˆ†é¡å®šç¾© ---
        const categories = [
            { id: 1, name: "ç°¡å–®å½¢å®¹è© / æ•¸å­—+é‡è©" },
            { id: 2, name: "æœ‰ç”Ÿå‘½çš„ (äºº/å‹•ç‰©/åœ°æ–¹ 's)" },
            { id: 3, name: "æœ‰...çš„ (with)" },
            { id: 4, name: "æ²’æœ‰...çš„ (without)" },
            { id: 5, name: "é—œæ–¼...çš„ (about)" },
            { id: 6, name: "ä¸»å‹•å‹•è© / Modal Verb" },
            { id: 7, name: "è¢«å‹•å‹•è© (p.p.)" },
            { id: 8, name: "è¤‡åˆå½¢å®¹è© (afraid of...ç­‰)" },
            { id: 9, name: "å¥å­ + çš„" },
            { id: 10, name: "æ­»ç‰©çš„æ­»ç‰© (the...of...)" },
            { id: 11, name: "åœ°æ–¹ + çš„" },
            { id: 12, name: "æ™‚é–“ + çš„" }
        ];

        // è¦å‰‡å°æ‡‰åˆ° Category ID çš„æ˜ å°„è¡¨
        const ruleToCategory = {
            3: 1,   // Rule 3: æ•¸å­—+é‡è© -> Cat 1
            1: 2,   // Rule 1: äººç¨± -> Cat 2
            2: 2,   // Rule 2: å‹•ç‰©/åœ°æ–¹ -> Cat 2
            7: 3,   // Rule 7: with -> Cat 3
            8: 4,   // Rule 8: without -> Cat 4
            13: 5,  // Rule 13: about -> Cat 5
            5: 6,   // Rule 5: ä¸»å‹•å‹•è© -> Cat 6
            6: 6,   // Rule 6: Modal verb -> Cat 6
            14: 7,  // Rule 14: è¢«å‹•å‹•è© -> Cat 7
            10: 8,  // Rule 10: è¤‡åˆå½¢å®¹è© -> Cat 8
            9: 9,   // Rule 9: å¥å­+çš„ -> Cat 9
            4: 10,  // Rule 4: æ­»ç‰©çš„æ­»ç‰© -> Cat 10
            12: 11, // Rule 12: åœ°æ–¹è© -> Cat 11
            11: 12  // Rule 11: æ™‚é–“è© -> Cat 12
        };

        // --- é¡Œç›®æ•¸æ“š (æ²¿ç”¨åŸæœ‰æ•¸æ“šä¸¦å°æ‡‰æ–°åˆ†é¡) ---
        const allQuestions = [
            // Rule 1 & 2 -> Category 2
            { rule: 1, chinese: "æˆ‘çš„æœ‹å‹çš„æ›¸", correct_tokens: [ ["my", "friend's", "book"] ] },
            { rule: 1, chinese: "å½¼å¾—çš„è»Š", correct_tokens: [ ["Peter's", "car"] ] },
            { rule: 2, chinese: "å°ç£çš„æ–‡åŒ–", correct_tokens: [ ["Taiwan's", "culture"] ] },
            { rule: 2, chinese: "é‚£éš»ç‹—çš„å°¾å·´", correct_tokens: [ ["the", "dog's", "tail"] ] },
            // Rule 3 -> Category 1
            { rule: 3, chinese: "ä¸€åº§äº”å±¤é«˜çš„å»ºç¯‰ç‰©", correct_tokens: [ ["a", "five-storey", "building"] ] },
            { rule: 3, chinese: "ä¸€å€‹åæ­²çš„ç”·å­©", correct_tokens: [ ["a", "ten-year-old", "boy"] ] },
            { rule: 3, chinese: "ä¸€å¼µä¸€ç™¾å…ƒçš„éˆ”ç¥¨", correct_tokens: [ ["a", "one-hundred-dollar", "bill"] ] },
            // Rule 4 -> Category 10
            { rule: 4, chinese: "é€™å€‹è¢‹å­çš„åƒ¹æ ¼", correct_tokens: [ ["the", "price", "of", "the", "bag"] ] },
            { rule: 4, chinese: "é€™æœ¬æ›¸çš„å°é¢", correct_tokens: [ ["the", "cover", "of", "the", "book"] ] },
            // Rule 5 & 6 -> Category 6
            { rule: 5, chinese: "ç¶“å¸¸å“­çš„é‚£å€‹ç”·å­©", correct_tokens: [ ["the", "boy", "who", "often", "cries"] ] },
            { rule: 5, chinese: "æ•™è‹±æ–‡çš„é‚£ä½è€å¸«", correct_tokens: [ ["the", "teacher", "who", "teaches", "English"] ] },
            { rule: 6, chinese: "ä¸€å€‹å”±å¾—å¾ˆå¥½çš„å¥³å­©", correct_tokens: [ ["a", "girl", "who", "can", "sing", "well"] ] },
            { rule: 6, chinese: "ä¸€å€‹å¯ä»¥å¹«åŠ©ä½ çš„äºº", correct_tokens: [ ["someone", "who", "can", "help", "you"] ] },
            // Rule 7 -> Category 3
            { rule: 7, chinese: "ä¸€å€‹æœ‰é•·é ­é«®çš„å¥³å­©", correct_tokens: [ ["a", "girl", "with", "long", "hair"] ] },
            { rule: 7, chinese: "ä¸€é–“æœ‰å¤§èŠ±åœ’çš„å±‹", correct_tokens: [ ["a", "house", "with", "a", "big", "garden"] ] },
            // Rule 8 -> Category 4
            { rule: 8, chinese: "ä¸€å€‹æ²’æœ‰å‹‡æ°£çš„äºº", correct_tokens: [ ["a", "man", "without", "courage"] ] },
            { rule: 8, chinese: "ä¸€æ¯æ²’æœ‰ç³–çš„å’–å•¡", correct_tokens: [ ["a", "cup", "of", "coffee", "without", "sugar"] ] },
            // Rule 9 -> Category 9
            { rule: 9, chinese: "æ¯å€‹äººéƒ½å–œæ­¡çš„é‚£å€‹æ­Œæ‰‹", correct_tokens: [ ["the", "singer", "everyone", "likes"], ["the", "singer", "who", "everyone", "likes"] ] },
            { rule: 9, chinese: "æˆ‘æ˜¨å¤©è²·çš„é‚£æœ¬æ›¸", correct_tokens: [ ["the", "book", "I", "bought", "yesterday"], ["the", "book", "which", "I", "bought", "yesterday"] ] },
            // Rule 10 -> Category 8
            { rule: 10, chinese: "ä¸€å€‹ç†±æ„›å”±æ­Œçš„å¥³å­©", correct_tokens: [ ["a", "girl", "fond", "of", "singing"], ["a", "girl", "who", "is", "fond", "of", "singing"] ] },
            { rule: 10, chinese: "ä¸€æœ¬å……æ»¿åœ–ç‰‡çš„æ›¸", correct_tokens: [ ["a", "book", "full", "of", "pictures"], ["a", "book", "which", "is", "full", "of", "pictures"] ] },
            // Rule 11 -> Category 12
            { rule: 11, chinese: "éå»çš„äººå€‘", correct_tokens: [ ["people", "in", "the", "past"] ] },
            { rule: 11, chinese: "æ˜å¤©çš„é‚£å€‹æœƒè­°", correct_tokens: [ ["the", "meeting", "tomorrow"] ] },
            // Rule 12 -> Category 11
            { rule: 12, chinese: "é‚£è£¡çš„äºº", correct_tokens: [ ["the", "people", "there"] ] },
            { rule: 12, chinese: "åœ¨æ¡Œä¸Šçš„é‚£æœ¬æ›¸", correct_tokens: [ ["the", "book", "on", "the", "table"] ] },
            // Rule 13 -> Category 5
            { rule: 13, chinese: "ä¸€æœ¬æœ‰é—œä¸­åœ‹çš„æ›¸", correct_tokens: [ ["a", "book", "about", "China"] ] },
            { rule: 13, chinese: "ä¸€å€‹é—œæ–¼æœªä¾†çš„è¨è«–", correct_tokens: [ ["a", "discussion", "about", "the", "future"] ] },
            // Rule 14 -> Category 7
            { rule: 14, chinese: "ä¸€å€‹è¢«ç¨±ç‚ºå®™æ–¯çš„ç”·äºº", correct_tokens: [ ["a", "man", "called", "Zeus"] ] },
            { rule: 14, chinese: "ä¸€æœ¬ç”¨è‹±èªå¯«çš„æ›¸", correct_tokens: [ ["a", "book", "written", "in", "English"] ] }
        ];

        // --- éŠæˆ²è®Šæ•¸ ---
        const TIME_LIMIT_SECONDS = 40; // è€ƒæ…®åˆ°è¦æ‰“å­—ï¼Œçµ¦äºˆæ›´å¤šæ™‚é–“
        const TIME_LIMIT_MS = TIME_LIMIT_SECONDS * 1000;
        let timerInterval, timeLeft;
        let currentQuestionIndex = 0, score = 0;
        let isAnswerChecked = false;
        let currentGameQuestions = []; 
        let gameHistory = []; 
        let selectedCategoryId = null;

        let promptEl, categoryGridEl, englishInputEl, feedbackEl, errorHistoryEl;
        let checkBtn, restartBtn, menuBtn, scoreDisplayEl, timerDisplayEl, timerBarEl, questionNumberEl;

        function getDOMElements() {
            promptEl = document.getElementById('chinese-prompt');
            categoryGridEl = document.getElementById('category-grid');
            englishInputEl = document.getElementById('english-input');
            feedbackEl = document.getElementById('feedback');
            errorHistoryEl = document.getElementById('error-history');
            checkBtn = document.getElementById('check-btn');
            restartBtn = document.getElementById('restart-btn');
            menuBtn = document.getElementById('menu-btn'); 
            
            scoreDisplayEl = document.querySelector('.score-display');
            timerDisplayEl = document.querySelector('.timer-display');
            timerBarEl = document.getElementById('timer-bar');
            questionNumberEl = document.querySelector('.question-number');
        }

        function renderCategoryButtons() {
            categoryGridEl.innerHTML = '';
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerText = cat.name;
                btn.onclick = () => {
                    if(isAnswerChecked) return;
                    audioClickPlay();
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedCategoryId = cat.id;
                };
                categoryGridEl.appendChild(btn);
            });
        }

        function startTimer() {
            stopTimer();
            timeLeft = TIME_LIMIT_MS;
            const startTime = Date.now();
            document.body.classList.remove('timer-warning');
            
            timerInterval = setInterval(() => {
                timeLeft = TIME_LIMIT_MS - (Date.now() - startTime);

                if (timeLeft <= 0) {
                    timeLeft = 0;
                    stopTimer();
                    checkAnswer(true); 
                }

                const seconds = Math.floor(timeLeft / 1000);
                timerDisplayEl.innerText = `${seconds}.0`;
                timerBarEl.style.width = `${Math.max(0, (timeLeft / TIME_LIMIT_MS) * 100)}%`; 
                
                if (timeLeft <= 5000) document.body.classList.add('timer-warning');
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
        }

        function startGame() {
            getDOMElements();
            currentQuestionIndex = 0;
            score = 0;
            gameHistory = [];
            
            // éš¨æ©ŸæŠ½å– 10 é¡Œ
            currentGameQuestions = [...allQuestions].sort(() => 0.5 - Math.random()).slice(0, 10);
            
            renderCategoryButtons();
            loadQuestion();
        }

        function loadQuestion() {
            isAnswerChecked = false;
            selectedCategoryId = null;
            englishInputEl.value = '';
            englishInputEl.disabled = false;
            feedbackEl.className = '';
            feedbackEl.innerHTML = '';
            errorHistoryEl.style.display = 'none'; 
            
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));

            checkBtn.innerText = "æª¢æŸ¥ç­”æ¡ˆ";
            checkBtn.style.display = 'block'; 
            restartBtn.style.display = 'none'; 

            if (currentQuestionIndex >= currentGameQuestions.length) {
                endGame();
                return;
            }

            scoreDisplayEl.innerHTML = `âœ“ ${score}/${currentQuestionIndex}`;
            questionNumberEl.innerText = `ç¬¬ ${currentQuestionIndex + 1} / ${currentGameQuestions.length} é¡Œ`;

            promptEl.innerText = currentGameQuestions[currentQuestionIndex].chinese;
            
            startTimer();
            englishInputEl.focus();
        }

        function formatTextForComparison(text) {
            // è½‰å°å¯«ï¼Œå»é ­å°¾ç©ºç™½ï¼Œå°‡å¤šå€‹ç©ºç™½ç¸®æˆä¸€å€‹ï¼Œç§»é™¤çµå°¾å¥è™Ÿ
            return text.toLowerCase().trim().replace(/\s+/g, ' ').replace(/\.$/, '');
        }

        function checkAnswer(isTimeout = false) {
            if (isAnswerChecked) return;
            isAnswerChecked = true;
            stopTimer();
            englishInputEl.disabled = true;

            const q = currentGameQuestions[currentQuestionIndex];
            const correctCatId = ruleToCategory[q.rule];
            const correctCatName = categories.find(c => c.id === correctCatId).name;
            
            // å°‡ correct_tokens é™£åˆ—çµ„è£æˆæ­£ç¢ºå¥å­çš„é™£åˆ—
            const correctAnswers = q.correct_tokens.map(arr => arr.join(' '));
            const formattedCorrectAnswers = correctAnswers.map(formatTextForComparison);
            
            const userInputText = englishInputEl.value;
            const formattedUserInput = formatTextForComparison(userInputText);

            const isCatCorrect = selectedCategoryId === correctCatId;
            const isTextCorrect = formattedCorrectAnswers.includes(formattedUserInput);

            gameHistory.push({
                questionIndex: currentQuestionIndex,
                chinese: q.chinese,
                isCatCorrect: isCatCorrect,
                isTextCorrect: isTextCorrect,
                userCatId: selectedCategoryId,
                userText: userInputText || "(æœªå¡«å¯«)",
                correctCatName: correctCatName,
                correctText: correctAnswers[0] // å–ç¬¬ä¸€å€‹ç•¶ä½œæ¨™æº–ç­”æ¡ˆå±•ç¤º
            });

            if (isTimeout) {
                audioIncorrectPlay();
                feedbackEl.className = 'feedback-incorrect';
                feedbackEl.innerHTML = `â° æ™‚é–“åˆ°ï¼<br>æ­£ç¢ºåˆ†é¡ï¼š<strong>${correctCatName}</strong><br>æ­£ç¢ºå¯«æ³•ï¼š<strong>${correctAnswers[0]}</strong>`;
            } else if (isCatCorrect && isTextCorrect) {
                audioCorrectPlay();
                score++;
                feedbackEl.className = 'feedback-correct';
                feedbackEl.innerHTML = `âœ… å®Œç¾ï¼åˆ†é¡èˆ‡è‹±æ–‡å…¨å°ï¼`;
            } else if (isCatCorrect && !isTextCorrect) {
                audioIncorrectPlay();
                feedbackEl.className = 'feedback-partial';
                feedbackEl.innerHTML = `âš ï¸ åˆ†é¡æ­£ç¢ºï¼Œä½†è‹±æ–‡æœ‰èª¤ï¼<br>æ­£ç¢ºå¯«æ³•æ‡‰ç‚ºï¼š<strong>${correctAnswers[0]}</strong>`;
            } else if (!isCatCorrect && isTextCorrect) {
                audioIncorrectPlay();
                feedbackEl.className = 'feedback-partial';
                feedbackEl.innerHTML = `âš ï¸ è‹±æ–‡æ­£ç¢ºï¼Œä½†åˆ†é¡éŒ¯èª¤ï¼<br>æ­£ç¢ºåˆ†é¡æ‡‰ç‚ºï¼š<strong>${correctCatName}</strong>`;
            } else {
                audioIncorrectPlay();
                feedbackEl.className = 'feedback-incorrect';
                feedbackEl.innerHTML = `âŒ åˆ†é¡èˆ‡è‹±æ–‡çš†éŒ¯èª¤ï¼<br>æ­£ç¢ºåˆ†é¡ï¼š<strong>${correctCatName}</strong><br>æ­£ç¢ºå¯«æ³•ï¼š<strong>${correctAnswers[0]}</strong>`;
            }

            checkBtn.innerText = "ä¸‹ä¸€é¡Œ";
        }

        function endGame() {
            stopTimer(); 
            const finalScore = score;
            const total = currentGameQuestions.length;
            const percentage = Math.round((finalScore / total) * 100);

            let resultMessage = `<div class="feedback-correct" style="padding:20px;">ğŸ‰ éŠæˆ²çµæŸï¼<br><h2>æ‚¨çš„æœ€çµ‚æˆç¸¾ï¼š${finalScore} / ${total} (${percentage}%)</h2></div>`;

            const mistakes = gameHistory.filter(h => !h.isCatCorrect || !h.isTextCorrect);
            if (mistakes.length > 0) {
                errorHistoryEl.innerHTML = `<h3>éŒ¯èª¤è¤‡ç¿’å€</h3>` + mistakes.map(h => {
                    let catHtml = h.isCatCorrect 
                        ? `<div class="error-detail">åˆ†é¡ï¼š<span class="correct-text">æ­£ç¢º (${h.correctCatName})</span></div>`
                        : `<div class="error-detail">åˆ†é¡ï¼š<span class="wrong-text">éŒ¯èª¤</span> â” æ­£ç¢ºç‚º <span class="correct-text">${h.correctCatName}</span></div>`;
                    
                    let textHtml = h.isTextCorrect 
                        ? `<div class="error-detail">å¥å­ï¼š<span class="correct-text">æ­£ç¢º (${h.userText})</span></div>`
                        : `<div class="error-detail">å¥å­ï¼š<span class="wrong-text">${h.userText}</span> â” æ­£ç¢ºç‚º <span class="correct-text">${h.correctText}</span></div>`;

                    return `<div class="error-item"><strong>é¡Œç›®ï¼š${h.chinese}</strong>${catHtml}${textHtml}</div>`;
                }).join('');
                errorHistoryEl.style.display = 'block';
            }

            feedbackEl.className = '';
            feedbackEl.innerHTML = resultMessage;
            
            promptEl.innerText = 'å®Œæˆæ¸¬é©—ï¼';
            categoryGridEl.innerHTML = '';
            englishInputEl.style.display = 'none';
            document.querySelectorAll('.step-label').forEach(el => el.style.display = 'none');
            
            checkBtn.style.display = 'none'; 
            restartBtn.style.display = 'block'; 
        }

        document.addEventListener('DOMContentLoaded', () => {
            getDOMElements();
            checkBtn.addEventListener('click', () => {
                if (checkBtn.innerText === "æª¢æŸ¥ç­”æ¡ˆ") {
                    if (!selectedCategoryId) {
                        alert("è«‹å…ˆé¸æ“‡ã€Œçš„ã€çš„é¡å‹ï¼");
                        return;
                    }
                    if (!englishInputEl.value.trim()) {
                        alert("è«‹è¼¸å…¥è‹±æ–‡å¥å­ï¼");
                        return;
                    }
                    checkAnswer();
                } else {
                    currentQuestionIndex++;
                    loadQuestion();
                }
            });
            restartBtn.addEventListener('click', () => {
                englishInputEl.style.display = 'block';
                document.querySelectorAll('.step-label').forEach(el => el.style.display = 'block');
                startGame();
            });
            menuBtn.addEventListener('click', () => { window.location.href = 'eng_game123.html'; }); 

            // æ”¯æ´æŒ‰ Enter æäº¤
            englishInputEl.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && checkBtn.innerText === "æª¢æŸ¥ç­”æ¡ˆ") {
                    checkBtn.click();
                }
            });

            startGame();
        });
    </script>
</body>
</html>
